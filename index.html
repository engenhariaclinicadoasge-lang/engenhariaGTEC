<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GTEC Brasil - Controle de Processos</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg0:#0f172a; --bg1:#1e293b;
      --card: #1e293b;
      --card-border: #334155;
      --muted:#94a3b8; --text:#f8fafc;
      --accent:#10b981; --accent-hover:#059669;
      --danger:#ef4444; --warn:#f59e0b;
      --line:#334155; --chip:#0f172a; --input:#020617;
      --shadow: 0 10px 25px rgba(0,0,0,.25);
      --headerbg: rgba(15, 23, 42, 0.85);
      --overlay: rgba(0,0,0,.7);
      --radius: 14px;
    }
    html[data-theme="light"]{
      --bg0:#f1f5f9; --bg1:#e2e8f0;
      --card: #ffffff;
      --card-border: #cbd5e1;
      --muted:#64748b; --text:#0f172a;
      --accent:#059669; --accent-hover:#047857;
      --danger:#dc2626; --warn:#d97706;
      --line:#e2e8f0; --chip:#f1f5f9; --input:#ffffff;
      --headerbg: rgba(255, 255, 255, 0.9);
      --overlay: rgba(255,255,255,.5);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg0);
      color:var(--text);
      line-height: 1.5;
    }
    header{
      position:sticky; top:0; z-index:50;
      background:var(--headerbg); backdrop-filter: blur(12px);
      border-bottom:1px solid var(--line);
      padding: 0.75rem 0;
    }
    .wrap{max-width:1280px; margin:0 auto; padding:0 1.5rem;}
    .topbar{display:flex; gap:1rem; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; align-items:center; gap:0.75rem;}
    .logo{
      width:44px; height:44px;
      border-radius:14px;
      background: linear-gradient(135deg, var(--accent), #22d3ee);
      color:white;
      display:grid; place-items:center;
      font-weight:800; font-size:1.2rem;
      box-shadow:0 10px 25px rgba(16,185,129,.4);
      animation: pulse 4s infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(16,185,129,.4);}
      70%{box-shadow:0 0 0 15px rgba(16,185,129,0);}
      100%{box-shadow:0 0 0 0 rgba(16,185,129,0);}
    }
    .brand h1{font-size:1.125rem; margin:0; font-weight: 700; letter-spacing: -0.025em;}
    .brand p{margin:0; color:var(--muted); font-size:0.75rem; font-weight: 500;}
    nav{display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; background: var(--chip); padding: 6px; border-radius: 999px; border: 1px solid var(--line);}
    .tab{
      padding: 0.55rem 1.2rem; border-radius:999px; border:none;
      background:transparent; color:var(--muted); cursor:pointer; font-weight:600; font-size: 0.875rem;
      transition: all 0.2s ease;
    }
    .tab:hover { color: var(--text); background: var(--bg0); }
    .tab.active{background: var(--card); color:var(--accent); box-shadow: var(--shadow);}
    main{padding: 2rem 0 4rem;}
    main > section{animation: fadeIn .25s ease;}
    @keyframes fadeIn{
      from{ opacity:0; transform:translateY(10px);}
      to{ opacity:1; transform:translateY(0);}
    }
    .grid{display:grid; gap:1.5rem;}
    .grid.cols-2{grid-template-columns:repeat(1, minmax(0,1fr));}
    .grid.cols-3{grid-template-columns:repeat(2, minmax(0,1fr));}
    @media (min-width: 1024px) { .grid.cols-2 { grid-template-columns: repeat(2, 1fr); } .grid.cols-3 { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 900px){ .grid.cols-3{grid-template-columns:1fr;} }
    .card{
      background: linear-gradient(145deg, var(--card), var(--bg0));
      border:1px solid var(--card-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.6rem;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
    }
    .card:hover{
      transform: translateY(-4px);
      box-shadow: 0 25px 50px rgba(0,0,0,.3);
      border-color: var(--accent);
    }
    .card h2{margin:0 0 0.5rem; font-size:1.15rem; font-weight: 700; color: var(--text);}
    .muted{color:var(--muted); font-size:0.875rem;}
    label{display:block; font-size:0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color:var(--muted); margin:0 0 0.5rem;}
    input, select, textarea{
      width:100%;
      padding: 0.75rem 0.8rem;
      background:var(--input);
      border:1px solid var(--line);
      border-radius: var(--radius);
      color:var(--text);
      outline:none;
      font-family: inherit;
      font-size: 0.95rem;
      transition: border-color 0.2s, box-shadow .2s;
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(16, 185, 129, 0.25);
    }
    input[readonly]{ opacity:0.7; cursor:not-allowed; background: var(--bg0); }
    .row{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:1rem;}
    @media (max-width:700px){ .row{grid-template-columns:1fr;} }
    .actions{display:flex; gap:0.75rem; flex-wrap:wrap; margin-top:1.5rem;}
    button{
      padding: 0.6rem 1.2rem;
      border-radius: 999px;
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      cursor:pointer;
      font-weight:600;
      font-size: 0.875rem;
      transition: all 0.2s;
      display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
    }
    button.primary{background:var(--accent); border-color:var(--accent); color:white;}
    button.primary:hover{background:var(--accent-hover); border-color:var(--accent-hover);}
    button.danger{background:rgba(239,68,68,0.1); border-color:rgba(239,68,68,0.3); color: var(--danger);}
    button.danger:hover{background:rgba(239,68,68,0.2);}
    button.ghost{background:transparent; border-color: transparent;}
    button.ghost:hover{background: var(--bg0);}
    button:active{transform: translateY(1px);}
    button:disabled{opacity:0.5; cursor:not-allowed; transform: none;}
    .table-container { border-radius: var(--radius); border: 1px solid var(--line); overflow: hidden; background: var(--card); }
    table{width:100%; border-collapse:collapse; font-size: 0.875rem;}
    thead th{
      text-align:left; font-size:0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color:var(--muted);
      padding: 1rem; border-bottom:1px solid var(--line);
      background:var(--bg0);
      position:sticky; top:0;
    }
    tbody td{ padding: 1rem; border-bottom:1px solid var(--line); vertical-align:middle; }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover{background:rgba(16,185,129,0.08);}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding: 0.25rem 0.75rem; border-radius:999px;
      background:var(--bg0);
      border:1px solid var(--line);
      font-size:0.75rem; font-weight: 600;
      white-space:nowrap;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .st-verde { background: var(--accent); }
    .st-amarelo { background: var(--warn); }
    .st-vermelho { background: var(--danger); }
    .st-cinza { background: var(--muted); }

    /* KPIs premium */
    .kpis{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));
      gap:1rem;
    }
    .kpi{
      position: relative;
      padding: 1.6rem;
      border-radius: 18px;
      background: linear-gradient(145deg, var(--card), var(--bg0));
      border: 1px solid var(--line);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      transition: all .25s ease;
      overflow:hidden;
    }
    .kpi::after{
      content:"";
      position:absolute;
      top:0; left:0;
      width:100%;
      height:4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
    }
    .kpi:hover{
      transform: translateY(-6px);
      box-shadow: 0 20px 40px rgba(0,0,0,.35);
      border-color: var(--accent);
    }
    .kpi .v{
      font-size:2.3rem;
      font-weight:800;
      line-height: 1;
      color: var(--text);
      margin-top: .4rem;
      letter-spacing:-1px;
    }
    .kpi .t{font-size:0.85rem; color:var(--muted); font-weight: 600;}

    /* Charts premium */
    .chart{
      width:100%;
      height:340px;
      border-radius:20px;
      border:1px solid var(--line);
      background: linear-gradient(145deg, var(--card), var(--bg0));
      padding:1.2rem;
      display:flex;
      flex-direction:column;
      transition:.25s ease;
    }
    .chart:hover{
      transform: translateY(-4px);
      box-shadow: 0 15px 35px rgba(0,0,0,.25);
      border-color: var(--accent);
    }
    .chart h3{
      margin:0 0 1rem;
      font-size:0.75rem;
      text-transform:uppercase;
      letter-spacing:.1em;
      color:var(--muted);
      text-align:center;
    }
    .chart canvas{flex:1;}

    .right{display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .search{min-width:260px;}
    .hidden{display:none !important;}
    .divider{height:1px; background:var(--line); margin:1.5rem 0;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 14px; border-radius:999px;
      border:1px solid var(--line);
      background:var(--bg0);
      font-size:0.75rem; color:var(--muted); font-weight: 600;
    }
    .ok{color:var(--accent)} .bad{color:var(--danger)}
    .toolbar{
      display:flex; gap:1rem; flex-wrap:wrap; align-items:flex-end; justify-content:space-between;
      margin-top:1rem;
    }
    .group{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;}
    .modal-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(6px);
      display:flex; align-items:center; justify-content:center;
      padding:1rem; z-index:9999;
    }
    .modal{
      width:min(620px, 100%);
      background:linear-gradient(145deg, var(--card), var(--bg0));
      border:1px solid var(--line);
      border-radius: 20px;
      box-shadow: 0 30px 60px rgba(0,0,0,.35);
      overflow:hidden; animation: popIn 0.25s ease-out;
    }
    @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-header{
      display:flex; align-items:center; justify-content:space-between;
      padding: 1.25rem; border-bottom:1px solid var(--line);
    }
    .modal-header h3{margin:0; font-size:1.125rem; font-weight: 700;}
    .modal-body{padding: 1.25rem;}
    .modal-footer{
      display:flex; gap:0.75rem; flex-wrap:wrap; justify-content:flex-end;
      padding: 1.25rem; border-top:1px solid var(--line); background: var(--bg0);
    }
    textarea#waPreviewText{
      min-height:200px; font-family: monospace; font-size: 0.875rem; line-height: 1.5;
    }
    .notice{
      padding:12px 14px; border-radius:16px;
      background:rgba(245,158,11,.12);
      border:1px solid rgba(245,158,11,.35);
      color:inherit;
      font-size:12px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">G</div>
        <div>
          <h1>GTEC Brasil</h1>
          <p>Controle de Processos</p>
        </div>
      </div>

      <div class="right">
        <div class="pill" id="connStatus">Conex√£o: <b class="bad">...</b></div>
        <button id="btnTheme" class="ghost" title="Alternar tema">üåì</button>
       
      </div>

      <nav>
        <button class="tab active" data-page="cadastro">üñãÔ∏èCadastro</button>
        <button class="tab" data-page="registro">üóíÔ∏èRegistros</button>
                <button class="tab" data-page="agendamentos">üìÖ Agendamentos</button>
<button class="tab" data-page="dash-geral">ü™õDashboard Geral</button>
        <button class="tab" data-page="dash-hospital">üè•Dashboard Hospital</button>
        <button class="ghost" onclick="openCalc()">üßÆ Calculadora implanta√ß√£o</button>
      </nav>
    </div>






    <!-- ALERTA DE VISITA/REUNI√ÉO -->
    <div id="visitAlert" class="notice hidden" style="margin-top:12px;"></div>
  </div>
</header>

<main class="wrap">
  <!-- ===================== REGISTRO ===================== -->
  <section id="page-registro" class="hidden grid">
    <div class="card">
      <div style="display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; margin-bottom: 1rem;">
        <div>
          <h2>Registros</h2>
          <p class="muted">Busca + exporta√ß√£o + a√ß√µes.</p>
        </div>

        <div class="right" style="flex: 1;">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; justify-content:flex-end; width:100%;">
            <div style="width:160px;">
              <label>Data inicial</label>
              <input id="waDataInicial" type="date" />
            </div>
            <div style="width:160px;">
              <label>Data final</label>
              <input id="waDataFinal" type="date" />
            </div>

            <input id="q" class="search" placeholder="üîç Buscar por processo, hospital, respons√°vel..." />
            <button id="btnExport" class="ghost" title="Exporta CSV">‚¨á CSV</button>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <div class="group">
          <div style="min-width: 220px;">
            <label>Exportar por respons√°vel</label>
            <select id="selResponsavelWA"></select>
          </div>
          <div style="width: 150px;">
            <label>Telefone (opcional)</label>
            <input id="waPhone" placeholder="5591..." />
          </div>
        </div>
        <div class="group">
          <button id="btnWhatsAppPreview" class="primary" style="background: #25D366; border-color: #25D366;">WhatsApp</button>
        </div>
      </div>

      <div class="divider"></div>

      <h3 style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Processos</h3>
      <div class="table-container" style="max-height:520px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Processo</th>
              <th>Setor</th>
              <th>Data</th>
              <th>Hospital</th>
              <th>Assunto</th>
              <th>Destino</th>
              <th>Respons√°vel</th>
              <th>Status</th>
              <th>Crit.</th>
              <th style="width:160px; text-align:right;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p class="muted" style="margin-top:10px; text-align:right;" id="countInfo"></p>
      <p class="muted" style="text-align:right;" id="lastSync"></p>
    </div>
  </section>

  

<!-- ===================== AGENDAMENTOS ===================== -->
<section id="page-agendamentos" class="hidden grid">
  <div class="card">
    <div style="display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; margin-bottom: 1rem;">
      <div>
        <h2>Agendamentos</h2>
        <p class="muted">Controle de visitas/reuni√µes, marca√ß√£o, conclus√£o e exporta√ß√£o em Excel.</p>
      </div>

      <div class="group" style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:flex-end;">
        <button id="btnAgendarVisita" class="primary">üìÖ Agendar visita</button>
        <button id="btnExportAgExcel" class="ghost" title="Baixar agendamentos em Excel">‚¨á Excel</button>
      </div>
    </div>

    <div class="divider"></div>

    <div class="table-container" style="max-height:650px; overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Hora</th>
            <th>Hospital</th>
            <th>Respons√°vel</th>
            <th>Tipo</th>
            <th>Realizada</th>
            <th style="width:180px; text-align:right;">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tbodyAg"></tbody>
      </table>
    </div>

    <p class="muted" style="margin-top:10px; text-align:right;">
      Dica: o alerta no topo mostra a pr√≥xima visita/reuni√£o pendente.
    </p>
  </div>
</section>

<!-- ===================== DASH GERAL ===================== -->
  <section id="page-dash-geral" class="hidden">
    <div class="grid">
      <div class="card">
        <h2>Dashboard Geral</h2>
        <p class="muted">Resumo autom√°tico baseado nos registros do Supabase.</p>

        <div style="margin-top:1rem; display:flex; gap:10px; flex-wrap:wrap;">
          <div class="pill">üìÖ Atualizado em tempo real</div>
          <div class="pill">üóÑ Base: Supabase</div>
          <div class="pill">üìç Setor: GTEC</div>
        </div>

        <div class="kpis" style="margin-top:1.2rem;">
          <div class="kpi">
            <div class="t">üìä Total</div>
            <div class="v" id="k_total">0</div>
          </div>
          <div class="kpi">
            <div class="t">üîÑ Tramitados</div>
            <div class="v" id="k_tram">0</div>
          </div>
          <div class="kpi">
            <div class="t">üöß Em andamento</div>
            <div class="v" id="k_and">0</div>
          </div>
          <div class="kpi">
            <div class="t">üìù Em valida√ß√£o</div>
            <div class="v" id="k_val">0</div>
          </div>
          <div class="kpi">
            <div class="t">‚ö†Ô∏è Pendentes</div>
            <div class="v" id="k_pend">0</div>
          </div>
        </div>
      </div>

      <div class="grid cols-3">
        <div class="chart"><h3>Status</h3><canvas id="pieStatus"></canvas></div>
        <div class="chart"><h3>Criticidade</h3><canvas id="pieCrit"></canvas></div>
      </div>

      <div class="grid cols-3">
        <div class="chart"><h3>Top Hospitais</h3><canvas id="barHospitais"></canvas></div>
        <div class="chart"><h3>Top Respons√°veis</h3><canvas id="barResponsaveis"></canvas></div>
      </div>
    </div>
  </section>

  <!-- ===================== CADASTRO ===================== -->
  <section id="page-cadastro" class="grid cols-2">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <h2>Novo registro</h2>
        <button class="ghost small" id="btnLimpar">Limpar</button>
      </div>
      <p class="muted">Setor fixo em <b>GTEC</b>.</p>

      <div class="row">
        <div>
          <label>N√∫mero do processo</label>
          <input id="f_numero" placeholder="Ex: 2026/000123" />
        </div>
        <div>
          <label>Setor (fixo)</label>
          <input id="f_setor" readonly />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Data</label>
          <input id="f_data" type="date" />
        </div>
        <div>
          <label>Hospital</label>
          <select id="f_hospital"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Assunto</label>
          <input id="f_assunto" placeholder="Ex: Termo de Refer√™ncia" />
        </div>
        <div>
          <label>Destino</label>
          <input id="f_destino" placeholder="Ex: Setor Y / SEI / Comiss√£o" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Respons√°vel</label>
          <input id="f_responsavel" placeholder="Ex: Jo√£o Pedro" />
        </div>
        <div>
          <label>Status</label>
          <select id="f_status">
            <option value="Em andamento">Em andamento</option>
            <option value="Em valida√ß√£o">Em valida√ß√£o</option>
            <option value="Pendente">Pendente</option>
            <option value="Tramitado">Tramitado</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Criticidade</label>
          <select id="f_criticidade">
            <option value="Baixa">Baixa</option>
            <option value="M√©dia" selected>M√©dia</option>
            <option value="Alta">Alta</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="pill" style="width:100%; text-align:center;">S√≥ edita se "Em andamento"</div>
        </div>
      </div>

      <div class="actions" style="justify-content:flex-end;">
        <button class="ghost" id="btnRecarregar" title="Recarrega do Supabase">Recarregar</button>
        <button class="primary" id="btnSalvar">Salvar Registro</button>
      </div>

      <div id="editBanner" class="notice hidden" style="margin-top:12px; display:flex; justify-content:space-between; align-items:center;">
        <span>Editando registro.</span>
        <button id="btnCancelarEdicao" class="ghost small">Cancelar</button>
      </div>
    </div>

    <div class="card">
      <h2>Importar Excel (.xlsx)</h2>
      <p class="muted">
        Colunas: <b>numero_processo, data, hospital, assunto, destino, responsavel, status, criticidade</b>.
      </p>

      <div style="margin-top:1.5rem; padding:1.5rem; border:2px dashed var(--line); border-radius:var(--radius); text-align:center;">
        <input type="file" id="fileXLSX" accept=".xlsx,.xls" />
      </div>

      <div style="margin-top:1rem;">
        <label>Planilha/Aba</label>
        <input id="sheetName" placeholder="Vazio = 1¬™ aba" />
      </div>

      <div class="actions">
        <button id="btnImportExcel" class="primary" style="width:100%;">Importar Excel para Supabase</button>
      </div>
    </div>
  </section>

  <!-- ===================== DASH HOSPITAL ===================== -->
  <section id="page-dash-hospital" class="hidden">
    <div class="grid">
      <div class="card">
        <div style="display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap;">
          <div>
            <h2>Dashboard por Hospital</h2>
            <p class="muted">Filtre e veja resumo do hospital selecionado.</p>
          </div>
          <div style="min-width:280px;">
            <label>Selecionar hospital</label>
            <select id="selHospital"></select>
          </div>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="t">üìä Total</div><div class="v" id="h_total">0</div></div>
        <div class="kpi"><div class="t">üöß Em andamento</div><div class="v" id="h_and">0</div></div>
        <div class="kpi"><div class="t">üìù Em valida√ß√£o</div><div class="v" id="h_val">0</div></div>
        <div class="kpi"><div class="t">‚ö†Ô∏è Pendentes</div><div class="v" id="h_pend">0</div></div>
        <div class="kpi"><div class="t">üîÑ Tramitados</div><div class="v" id="h_tram">0</div></div>
      </div>

      <div class="grid cols-2">
        <div class="chart"><h3>Criticidade</h3><canvas id="pieHCrit"></canvas></div>
        <div class="chart"><h3>Status</h3><canvas id="pieHStatus"></canvas></div>
      </div>

      <div class="card">
        <h2>√öltimos registros do hospital</h2>
        <div class="table-container" style="max-height:440px; overflow:auto; margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>Data</th><th>Processo</th><th>Setor</th><th>Assunto</th><th>Destino</th><th>Respons√°vel</th><th>Status</th><th>Criticidade</th>
              </tr>
            </thead>
            <tbody id="tbodyHospital"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- ===================== IMPLANTA√á√ÉO ===================== -->
  <section id="page-implantacao" class="hidden">
    <div class="card">
      <h2>Implanta√ß√£o</h2>
      <p class="muted">√Årea destinada ao controle de implanta√ß√£o.</p>
      <div style="min-height: 400px; display:flex; align-items:center; justify-content:center; color:var(--muted);">
        (Aguardando a equipe do bolo passar os dados para verificar se vai dar pra implantar nesse estilo de CODIGO)
      </div>
    </div>
  </section>
</main>

<!-- MODAL WhatsApp -->
<div id="waModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-header">
      <h3>Pr√©via da mensagem (WhatsApp)</h3>
      <button class="ghost" id="btnCloseWaModal">‚úï</button>
    </div>
    <div class="modal-body">
      <p class="muted" style="margin-top:0;">Edite antes de enviar.</p>
      <label>Texto</label>
      <textarea id="waPreviewText"></textarea>
      <div class="muted" id="waCharCount" style="margin-top:6px; text-align:right;"></div>
    </div>
    <div class="modal-footer">
      <button id="btnCopyWa" class="ghost">Copiar</button>
      <button id="btnOpenWa" class="primary" style="background:#25D366; border-color:#25D366;">Abrir WhatsApp</button>
    </div>
  </div>
</div>

<!-- MODAL Agendamento -->
<div id="agModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-header">
      <h3>Agendar visita/reuni√£o</h3>
      <button class="ghost" id="btnCloseAgModal">‚úï</button>
    </div>
    <div class="modal-body">
      <p class="muted" style="margin-top:0;">Registre data/hora e acompanhe.</p>

      <div class="row">
        <div>
          <label>Data</label>
          <input id="ag_data" type="date" />
        </div>
        <div>
          <label>Hora (opcional)</label>
          <input id="ag_hora" type="time" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Hospital</label>
          <select id="ag_hospital"></select>
        </div>
        <div>
          <label>Respons√°vel</label>
          <input id="ag_responsavel" placeholder="Ex: Jo√£o Pedro" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Tipo</label>
          <select id="ag_tipo">
            <option value="Visita">Visita</option>
            <option value="Reuni√£o">Reuni√£o</option>
          </select>
        </div>
        <div>
          <label>Observa√ß√£o (opcional)</label>
          <input id="ag_obs" placeholder="Ex: pauta, local, etc." />
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="btnSaveAg" class="primary">Salvar agendamento</button>
    </div>
  </div>
</div>

<script>
/** SUPABASE */
const SUPABASE_URL = "https://aykvdakgvugxuurioqum.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5a3ZkYWtndnVneHV1cmlvcXVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MTA1OTIsImV4cCI6MjA4NjE4NjU5Mn0.T3HPPYsmy3-Xi9aBmdkJEWyy6RKqWvSWLtYzKyfwFSg";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);





function openCalc(){
  document.getElementById("calcModal").classList.remove("hidden");
}

function closeCalc(){
  document.getElementById("calcModal").classList.add("hidden");
}











/** SETOR FIXO */
const FIXED_SETOR = "GTEC - Grupo Tecnico de Engenharia Clinica.";

/** LISTA FIXA DE HOSPITAIS */
const HOSPITAIS = [
  "POLICL√çNICA DE TUCURU√ç",
  "POLICLINICA METROPOLITANA DE BEL√âM",
  "HOSPITAL DE CLINICAS GASPAR VIANA",
  "HOSPITAL GERAL DE IPIXUNA DO PARA",
  "HOSPITAL GERAL DE TAILANDIA",
  "HOSPITAL JEAN BITAR",
  "HOSPITAL METROPOLITANO DE URG√äNCIA E EMERG√äNCIA",
  "HOSPITAL ONCOL√ìGICO INFANTIL OCT√ÅVIO LOBO",
  "HOSPITAL OPHIR LOYOLA",
  "HOSPITAL P√öBLICO ESTADUAL GALILEU",
  "HOSPITAL P√öBLICO GERAL DOS CASTELO DOS SONHOS",
  "HOSPITAL REGIONAL DE CAMETA",
  "HOSPITAL REGIONAL DE CONCEICAO DO ARAGUAIA",
  "HOSPITAL REGIONAL DE TUCURUI",
  "HOSPITAL REGIONAL DO BAIXO AMAZONAS DO PA DR WALDEMAR PENNA",
  "HOSPITAL SANTA ROSA",
  "HOSPITAL REGIONAL DO SUDESTE DO PARA DR GERALDO VELOSO",
  "HOSPITAL REGIONAL DR OLIMPIO CARDOSO DA SILVEIRA",
  "HOSPITAL REGIONAL P√öBLICO DA TRANSAMAZ√îNICA",
  "HOSPITAL REGIONAL P√öBLICO DE CASTANHAL",
  "HOSPITAL REGIONAL P√öBLICO DO ARAGUAIA",
  "HOSPITAL REGIONAL PUBLICO DO LESTE DO PARA",
  "HOSPITAL REGIONAL PUBLICO DO MARAJO",
  "HOSPITAL REGIONAL P√öBLICO DO TAPAJOS ITAITUBA",
  "HOSPITAL REGIONAL P√öBLICO DOS CAETES DR JORGE NETO DA COSTA",
  "HOSPITAL REGIONAL PUBLICO DR ABELARDO SANTOS",
  "HOSPITAL REGIONAL P√öBLICO MATERNO INFANTIL DE BARCARENA",
  "Centro Integrado de Inclus√£o e Reabilita√ß√£o - CIIR",
  "HOSPITAL DA MULHER SENHORA DE NAZAR√â",
  "HOSPITAL MATERNO INFANTIL DE ALTAMIRA",
  "HOSPITAL MATERNO INFANTIL DE BREVES",
  "HOSPITAL MATERNO INFANTIL DE MARAB√Å",
  "HOSPITAL MATERNO INFANTIL DE SANTAR√âM",
  "HOSPITAL MUNICIPAL DE RIO MARIA",
  "HOSPITAL PRONTO SOCORRO",
  "POLICL√çNICA DE ALTAMIRA",
  "POLICL√çNICA DE BREVES",
  "POLICLINICA DE CAPANEMA",
  "POLICL√çNICA DE MARAB√Å",
  "POLICL√çNICA DE SANTAR√âM"
];

/** STATE */
let data = [];
let editingId = null;
let pieStatus, pieCrit, barHosp, barResp;
let pieHCrit, pieHStatus;
let waMessageDraft = "";

/** AGENDAMENTOS STATE */
let agendamentos = [];
let agUseLocal = false;
const AG_LOCAL_KEY = "cp_agendamentos_v1";

/** HELPERS */
const $ = (id) => document.getElementById(id);
const esc = (s) => (s ?? "").toString().replace(/[&<>"']/g, m => ({
  "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
}[m]));
function normalize(s){ return (s ?? "").toString().trim(); }
function toast(msg){ alert(msg); }
function setBusy(isBusy){
  document.querySelectorAll("main button, .modal button").forEach(b => {
    b.disabled = isBusy;
  });
}
function fmtDate(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  return (d && m && y) ? `${d}/${m}/${y}` : iso;
}
function connBadge(ok){
  const el = $("connStatus");
  el.innerHTML = ok ? `Conex√£o: <b class="ok">OK</b>` : `Conex√£o: <b class="bad">ERRO</b>`;
}
function normalizeCrit(v){
  const x = normalize(v);
  if(!x) return "M√©dia";
  const low = x.toLowerCase();
  if(low.includes("alta")) return "Alta";
  if(low.includes("baixa")) return "Baixa";
  return "M√©dia";
}
function normalizeStatus(v){
  const x = normalize(v);
  if(!x) return "Em andamento";
  const low = x.toLowerCase();
  if(low.includes("val")) return "Em valida√ß√£o";
  if(low.includes("pend")) return "Pendente";
  if(low.includes("tram")) return "Tramitado";
  if(low.includes("and")) return "Em andamento";
  if(low.includes("conclu")) return "Tramitado";
  return x;
}

/** THEME */
const THEME_KEY = "cp_theme_v3";
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem(THEME_KEY, theme);
}
function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  if(saved === "light" || saved === "dark") applyTheme(saved);
}
if($("btnTheme")) $("btnTheme").addEventListener("click", () => {
  const current = document.documentElement.getAttribute("data-theme") || "dark";
  applyTheme(current === "dark" ? "light" : "dark");
});

/** NAVEGA√á√ÉO */
document.querySelectorAll(".tab").forEach(t => {
  t.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
    t.classList.add("active");
    document.querySelectorAll("main > section").forEach(s => s.classList.add("hidden"));
    const target = $("page-" + t.dataset.page);
    if(target){
      target.classList.remove("hidden");
      if(t.dataset.page.startsWith("dash")){
        setTimeout(renderDashboards, 50);
      }
    }
  });
});

/** INIT selects */
function initFixedFields(){
  $("f_setor").value = FIXED_SETOR;

  const selHosp = $("f_hospital");
  selHosp.innerHTML = "";
  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = "Selecione um hospital...";
  selHosp.appendChild(ph);

  for(const h of HOSPITAIS){
    const opt = document.createElement("option");
    opt.value = h;
    opt.textContent = h;
    selHosp.appendChild(opt);
  }

  const agHosp = $("ag_hospital");
  agHosp.innerHTML = "";
  const ph2 = document.createElement("option");
  ph2.value = "";
  ph2.textContent = "Selecione um hospital...";
  agHosp.appendChild(ph2);
  for(const h of HOSPITAIS){
    const opt = document.createElement("option");
    opt.value = h;
    opt.textContent = h;
    agHosp.appendChild(opt);
  }
}

/** FORM */
function getForm(){
  return {
    numero_processo: normalize($("f_numero").value),
    setor: FIXED_SETOR,
    data: $("f_data").value || "",
    hospital: $("f_hospital").value || "",
    assunto: normalize($("f_assunto").value),
    destino: normalize($("f_destino").value),
    responsavel: normalize($("f_responsavel").value),
    status: $("f_status").value || "Em andamento",
    criticidade: $("f_criticidade").value || "M√©dia"
  };
}
function setForm(r){
  $("f_numero").value = r?.numero_processo || "";
  $("f_setor").value = FIXED_SETOR;
  $("f_data").value = r?.data || "";
  $("f_hospital").value = r?.hospital || "";
  $("f_assunto").value = r?.assunto || "";
  $("f_destino").value = r?.destino || "";
  $("f_responsavel").value = r?.responsavel || "";
  $("f_status").value = r?.status || "Em andamento";
  $("f_criticidade").value = r?.criticidade || "M√©dia";
}
function clearForm(){ setForm(null); }
function validate(r){
  if(!r.numero_processo) return "Informe o n√∫mero do processo.";
  if(!r.data) return "Informe a data.";
  if(!r.hospital) return "Selecione o hospital.";
  if(!r.assunto) return "Informe o assunto.";
  if(!r.destino) return "Informe o destino.";
  if(!r.responsavel) return "Informe o respons√°vel.";
  return null;
}

/** ‚úÖ POPULA SELECT DE RESPONS√ÅVEIS */
function renderResponsaveisSelect(){
  const sel = $("selResponsavelWA");
  if(!sel) return;

  const responsaveis = Array.from(
    new Set((data || [])
      .map(r => normalize(r.responsavel))
      .filter(Boolean))
  ).sort((a,b)=>a.localeCompare(b,"pt-BR"));

  sel.innerHTML =
    `<option value="">Todos os respons√°veis</option>` +
    responsaveis.map(r => `<option value="${esc(r)}">${esc(r)}</option>`).join("");
}

/** ‚úÖ FILTRO √öNICO (WHATSAPP): DATA + RESPONS√ÅVEL + BUSCA */
function getFilteredForWhatsApp(){
  let filtered = [...(data || [])];

  // Busca (o que estiver digitado)
  const q = normalize($("q")?.value).toLowerCase();
  if(q){
    filtered = filtered.filter(r => {
      const blob = [
        r.numero_processo, r.setor, r.data, r.hospital,
        r.assunto, r.destino, r.responsavel, r.status, r.criticidade
      ].join(" ").toLowerCase();
      return blob.includes(q);
    });
  }

  // Respons√°vel selecionado
  const respSel = normalize($("selResponsavelWA")?.value);
  if(respSel){
    filtered = filtered.filter(r => normalize(r.responsavel) === respSel);
  }

  // Datas
  const dataInicial = $("waDataInicial")?.value;
  const dataFinal = $("waDataFinal")?.value;

  if(dataInicial){
    const di = new Date(dataInicial + "T00:00:00");
    filtered = filtered.filter(r => r.data && new Date(r.data + "T00:00:00") >= di);
  }
  if(dataFinal){
    const df = new Date(dataFinal + "T23:59:59");
    filtered = filtered.filter(r => r.data && new Date(r.data + "T00:00:00") <= df);
  }

  return filtered;
}

/** AGENDAMENTOS HELPERS */
function agLoadLocal(){
  try{
    const raw = localStorage.getItem(AG_LOCAL_KEY);
    const parsed = raw ? JSON.parse(raw) : [];
    if(Array.isArray(parsed)) return parsed;
  }catch{}
  return [];
}
function agSaveLocal(list){
  localStorage.setItem(AG_LOCAL_KEY, JSON.stringify(list || []));
}
function agSort(list){
  return [...(list||[])].sort((a,b)=>{
    const da = (a.data||"");
    const db = (b.data||"");
    if(db !== da) return db.localeCompare(da);
    return (b.hora||"").localeCompare(a.hora||"");
  });
}
function agNormalizeRow(r){
  return {
    id: r.id,
    data: r.data || "",
    hora: r.hora || "",
    hospital: r.hospital || "",
    responsavel: r.responsavel || "",
    tipo: r.tipo || "Visita",
    observacao: r.observacao || "",
    realizada: !!r.realizada,
    created_at: r.created_at || null,
    updated_at: r.updated_at || null
  };
}
function agTodayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

/** SUPABASE */
async function testConnection(){
  try{
    const { error } = await sb.from("processos").select("id").limit(1);
    connBadge(!error);
    if(error) console.error(error);
  }catch(e){
    connBadge(false);
    console.error(e);
  }
}
async function loadFromSupabase(){
  setBusy(true);
  try{
    const { data: rows, error } = await sb
      .from("processos")
      .select("*")
      .order("created_at", { ascending: false });

    if(error) throw error;

    data = (rows || []).map(r => ({
      ...r,
      setor: FIXED_SETOR,
      status: normalizeStatus(r.status),
      criticidade: r.criticidade ? normalizeCrit(r.criticidade) : "M√©dia"
    }));

    $("lastSync").textContent = `√öltima atualiza√ß√£o: ${new Date().toLocaleString()}`;

    // garante que o select puxe os respons√°veis
    renderResponsaveisSelect();

    renderAll();
  }catch(e){
    console.error(e);
    toast("Erro ao carregar do Supabase (RLS/Policies).");
  }finally{
    setBusy(false);
  }
}
async function insertRecord(record){
  const { data: row, error } = await sb.from("processos").insert({ ...record }).select("*").single();
  if(error) throw error;
  return row;
}
async function updateRecord(id, record){
  const payload = { ...record, updated_at: new Date().toISOString() };
  const { data: row, error } = await sb.from("processos").update(payload).eq("id", id).select("*").single();
  if(error) throw error;
  return row;
}
async function deleteRecord(id){
  const { error } = await sb.from("processos").delete().eq("id", id);
  if(error) throw error;
}

/** AGENDAMENTOS (Supabase com fallback local) */
async function agTryLoadSupabase(){
  try{
    const { data: rows, error } = await sb
      .from("agendamentos")
      .select("*")
      .order("created_at", { ascending: false });

    if(error) throw error;

    agUseLocal = false;
    agendamentos = (rows||[]).map(agNormalizeRow);
  }catch(e){
    console.warn("Agendamentos: fallback local (tabela/policies n√£o dispon√≠veis).", e);
    agUseLocal = true;
    agendamentos = agLoadLocal().map(agNormalizeRow);
  }
}
async function agInsert(item){
  if(agUseLocal){
    const local = agLoadLocal();
    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2);
    const row = agNormalizeRow({ ...item, id, realizada: false, created_at: new Date().toISOString() });
    local.unshift(row);
    agSaveLocal(local);
    agendamentos = local.map(agNormalizeRow);
    return row;
  }
  try{
    const payload = { ...item, realizada: false };
    const { data: row, error } = await sb.from("agendamentos").insert(payload).select("*").single();
    if(error) throw error;
    const normalized = agNormalizeRow(row);
    agendamentos.unshift(normalized);
    return normalized;
  }catch(e){
    console.warn("Falha ao inserir no Supabase, salvando localmente.", e);
    agUseLocal = false;
    return agInsert(item);
  }
}
async function agToggleRealizada(id){
  const current = agendamentos.find(x => x.id === id);
  if(!current) return;
  const newVal = !current.realizada;

  if(agUseLocal){
    const local = agLoadLocal().map(agNormalizeRow).map(x => x.id === id ? { ...x, realizada: newVal, updated_at: new Date().toISOString() } : x);
    agSaveLocal(local);
    agendamentos = local;
    return;
  }

  try{
    const { data: row, error } = await sb
      .from("agendamentos")
      .update({ realizada: newVal, updated_at: new Date().toISOString() })
      .eq("id", id)
      .select("*")
      .single();
    if(error) throw error;
    const normalized = agNormalizeRow(row);
    agendamentos = agendamentos.map(x => x.id === id ? normalized : x);
  }catch(e){
    console.warn("Falha ao atualizar no Supabase, atualizando localmente.", e);
    agUseLocal = true;
    await agToggleRealizada(id);
  }
}
async function agDelete(id){
  if(agUseLocal){
    const local = agLoadLocal().map(agNormalizeRow).filter(x => x.id !== id);
    agSaveLocal(local);
    agendamentos = local;
    return;
  }
  try{
    const { error } = await sb.from("agendamentos").delete().eq("id", id);
    if(error) throw error;
    agendamentos = agendamentos.filter(x => x.id !== id);
  }catch(e){
    console.warn("Falha ao excluir no Supabase, excluindo localmente.", e);
    agUseLocal = true;
    await agDelete(id);
  }
}

/** TABLE */
function renderTable(){
  const q = normalize($("q").value).toLowerCase();
  const tbody = $("tbody");

  const filtered = data.filter(r => {
    if(!q) return true;
    const blob = [
      r.numero_processo, r.setor, r.data, r.hospital,
      r.assunto, r.destino, r.responsavel, r.status, r.criticidade
    ].join(" ").toLowerCase();
    return blob.includes(q);
  });

  tbody.innerHTML = filtered.map(r => {
    const canEdit = (r.status === "Em andamento");
    const dot =
      r.status === "Tramitado" ? "st-verde" :
      r.status === "Em valida√ß√£o" ? "st-amarelo" :
      r.status === "Em andamento" ? "st-amarelo" :
      r.status === "Pendente" ? "st-vermelho" : "st-cinza";

    return `
      <tr>
        <td><span class="chip">${esc(r.numero_processo)}</span></td>
        <td>${esc(FIXED_SETOR)}</td>
        <td>${esc(fmtDate(r.data))}</td>
        <td>${esc(r.hospital)}</td>
        <td>${esc(r.assunto)}</td>
        <td>${esc(r.destino)}</td>
        <td>${esc(r.responsavel)}</td>
        <td><span class="status-dot ${dot}"></span>${esc(r.status)}</td>
        <td>${esc(r.criticidade || "M√©dia")}</td>
        <td style="text-align:right;">
          ${canEdit ? `<button class="ghost small" onclick="onEdit('${r.id}')">Editar</button>` : ``}
          <button class="danger small" onclick="onDelete('${r.id}')">Excluir</button>
        </td>
      </tr>
    `;
  }).join("");

  $("countInfo").textContent = `Mostrando ${filtered.length} de ${data.length} registros.`;
}

/** AG TABLE */
function renderAgTable(){
  const tbody = $("tbodyAg");
  const list = agSort(agendamentos);

  tbody.innerHTML = list.map(a => `
    <tr>
      <td>${esc(fmtDate(a.data))}</td>
      <td>${esc(a.hora || "")}</td>
      <td>${esc(a.hospital || "")}</td>
      <td>${esc(a.responsavel || "")}</td>
      <td>${esc(a.tipo || "Visita")}</td>
      <td>${a.realizada ? `<span class="chip ok">‚úÖ Sim</span>` : `<span class="chip">‚è≥ N√£o</span>`}</td>
      <td style="text-align:right;">
        <button class="ghost small" onclick="onAgToggle('${a.id}')">${a.realizada ? "Desfazer" : "Concluir"}</button>
        <button class="danger small" onclick="onAgDelete('${a.id}')">üóëÔ∏è</button>
      </td>
    </tr>
  `).join("");

  renderVisitAlert();
}

function renderVisitAlert(){
  const el = $("visitAlert");
  const today = agTodayISO();

  const upcoming = agendamentos
    .filter(a => !!a.data)
    .filter(a => !a.realizada)
    .sort((a,b)=> (a.data||"").localeCompare(b.data||"") || (a.hora||"").localeCompare(b.hora||""));

  const todayItems = upcoming.filter(a => a.data === today);
  const nextItem = upcoming.find(a => a.data >= today);

  if(todayItems.length){
    const lines = todayItems.slice(0,3).map(a => `‚Ä¢ ${a.tipo || "Visita"} - ${a.hospital || "(hospital)"}${a.hora ? " √†s " + a.hora : ""} (${a.responsavel || "sem respons√°vel"})`);
    el.innerHTML = `üìå <b>ALERTA:</b> H√° visita/reuni√£o <b>marcada para hoje (${fmtDate(today)})</b>:<br>${esc(lines.join("\n")).replaceAll("\n","<br>")}`;
    el.classList.remove("hidden");
    return;
  }

  if(nextItem && nextItem.data){
    el.innerHTML = `üìÖ Pr√≥xima visita/reuni√£o marcada para <b>${esc(fmtDate(nextItem.data))}</b>${nextItem.hora ? ` √†s <b>${esc(nextItem.hora)}</b>` : ""} ‚Äî ${esc(nextItem.tipo || "Visita")} em <b>${esc(nextItem.hospital || "")}</b> (${esc(nextItem.responsavel || "sem respons√°vel")}).`;
    el.classList.remove("hidden");
    return;
  }

  el.classList.add("hidden");
}

window.onEdit = (id) => {
  const r = data.find(x => x.id === id);
  if(!r) return;
  if(r.status !== "Em andamento"){
    toast("S√≥ √© permitido editar quando o status estiver 'Em andamento'.");
    return;
  }
  editingId = id;
  setForm(r);
  $("editBanner").classList.remove("hidden");
  document.querySelector('[data-page="cadastro"]').click();
};

window.onDelete = async (id) => {
  const r = data.find(x => x.id === id);
  if(!r) return;
  if(!confirm(`Excluir o processo "${r.numero_processo}"?`)) return;

  setBusy(true);
  try{
    await deleteRecord(id);
    data = data.filter(x => x.id !== id);
    if(editingId === id){
      editingId = null;
      $("editBanner").classList.add("hidden");
      clearForm();
    }
    renderAll();
  }catch(e){
    console.error(e);
    toast("Erro ao excluir (RLS/Policies).");
  }finally{
    setBusy(false);
  }
};

window.onAgToggle = async (id) => {
  setBusy(true);
  try{
    await agToggleRealizada(id);
    renderAgTable();
  }finally{
    setBusy(false);
  }
};
window.onAgDelete = async (id) => {
  if(!confirm("Excluir este agendamento?")) return;
  setBusy(true);
  try{
    await agDelete(id);
    renderAgTable();
  }finally{
    setBusy(false);
  }
};

async function onSave(){
  const r = getForm();
  const err = validate(r);
  if(err){ toast(err); return; }

  setBusy(true);
  try{
    if(editingId){
      const current = data.find(x => x.id === editingId);
      if(current && current.status !== "Em andamento"){
        toast("N√£o foi poss√≠vel salvar: o status n√£o est√° mais 'Em andamento'.");
        return;
      }
      const updated = await updateRecord(editingId, r);
      data = data.map(x => x.id === editingId ? { ...updated, setor: FIXED_SETOR, criticidade: normalizeCrit(updated.criticidade||"M√©dia"), status: normalizeStatus(updated.status)} : x);
      editingId = null;
      $("editBanner").classList.add("hidden");
    }else{
      const inserted = await insertRecord(r);
      data.unshift({ ...inserted, setor: FIXED_SETOR, criticidade: normalizeCrit(inserted.criticidade||"M√©dia"), status: normalizeStatus(inserted.status) });
    }
    clearForm();

    // atualiza lista de respons√°veis
    renderResponsaveisSelect();

    renderAll();
    toast("Salvo com sucesso!");
  }catch(e){
    console.error(e);
    toast("Erro ao salvar no Supabase (RLS/Policies).");
  }finally{
    setBusy(false);
  }
}
function onCancelEdit(){
  editingId = null;
  $("editBanner").classList.add("hidden");
  clearForm();
}

/** EXPORT CSV */
function exportCSV(){
  if(!data.length){ toast("Sem dados para exportar."); return; }
  const headers = ["numero_processo","setor","data","hospital","assunto","destino","responsavel","status","criticidade"];
  const lines = [
    headers.join(","),
    ...data.map(r => headers.map(h => {
      const v = (r[h] ?? (h==="setor"?FIXED_SETOR:"")).toString().replaceAll('"','""');
      return `"${v}"`;
    }).join(","))
  ];
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "processos.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/** EXPORT AGENDAMENTOS (EXCEL) */
function exportAgExcel(){
  const list = agSort(agendamentos);
  if(!list.length){ toast("Sem agendamentos para exportar."); return; }

  const rows = list.map(a => ({
    "Data": fmtDate(a.data),
    "Hora": a.hora || "",
    "Hospital": a.hospital || "",
    "Respons√°vel": a.responsavel || "",
    "Tipo": a.tipo || "Visita",
    "Realizada": a.realizada ? "Sim" : "N√£o",
    "Observa√ß√£o": a.observacao || "",
    "Criado em": a.created_at ? new Date(a.created_at).toLocaleString() : "",
    "Atualizado em": a.updated_at ? new Date(a.updated_at).toLocaleString() : ""
  }));

  const ws = XLSX.utils.json_to_sheet(rows);
  ws["!cols"] = [
    { wch: 12 }, // Data
    { wch: 10 }, // Hora
    { wch: 45 }, // Hospital
    { wch: 22 }, // Respons√°vel
    { wch: 12 }, // Tipo
    { wch: 10 }, // Realizada
    { wch: 40 }, // Observa√ß√£o
    { wch: 22 }, // Criado em
    { wch: 22 }  // Atualizado em
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Agendamentos");

  const stamp = agTodayISO();
  XLSX.writeFile(wb, `agendamentos_${stamp}.xlsx`);
}

/** IMPORT EXCEL */
function normalizeHeader(h){
  return normalize(h).toLowerCase().replaceAll(" ", "_").replaceAll("-", "_");
}
function excelDateToISO(v){
  if(typeof v === "string" && /^\d{4}-\d{2}-\d{2}$/.test(v.trim())) return v.trim();
  if(typeof v === "number"){
    const date = XLSX.SSF.parse_date_code(v);
    if(date){
      const y = date.y;
      const m = String(date.m).padStart(2,"0");
      const d = String(date.d).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }
  }
  return "";
}
async function importExcel(){
  const file = $("fileXLSX").files[0];
  if(!file){ toast("Selecione um arquivo Excel."); return; }

  const sheetName = normalize($("sheetName").value);

  setBusy(true);
  try{
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type: "array" });
    const ws = sheetName ? wb.Sheets[sheetName] : wb.Sheets[wb.SheetNames[0]];
    if(!ws){ toast("Aba n√£o encontrada."); return; }

    const json = XLSX.utils.sheet_to_json(ws, { defval: "" });
    if(!json.length){ toast("Planilha vazia."); return; }

    const rows = json.map(row => {
      const obj = {};
      Object.keys(row).forEach(k => obj[normalizeHeader(k)] = row[k]);
      return {
        numero_processo: normalize(obj.numero_processo),
        setor: FIXED_SETOR,
        data: excelDateToISO(obj.data),
        hospital: normalize(obj.hospital),
        assunto: normalize(obj.assunto),
        destino: normalize(obj.destino),
        responsavel: normalize(obj.responsavel),
        status: normalizeStatus(obj.status || "Em andamento"),
        criticidade: normalizeCrit(obj.criticidade || "M√©dia")
      };
    });

    for(const r of rows){
      if(!r.numero_processo || !r.data || !r.hospital || !r.assunto || !r.destino || !r.responsavel){
        console.warn("Registro ignorado por falta de campos obrigat√≥rios:", r);
        continue;
      }
      await insertRecord(r);
    }

    toast("Importa√ß√£o conclu√≠da!");
    await loadFromSupabase();
  }catch(e){
    console.error(e);
    toast("Erro ao importar Excel.");
  }finally{
    setBusy(false);
  }
}

/** DASHBOARDS */
function destroyCharts(){
  [pieStatus, pieCrit, barHosp, barResp, pieHCrit, pieHStatus].forEach(c => {
    if(c && typeof c.destroy === "function") c.destroy();
  });
  pieStatus = pieCrit = barHosp = barResp = pieHCrit = pieHStatus = null;
}

function renderDashboards(){
  destroyCharts();

  // KPIs gerais
  const total = data.length;
  const tram = data.filter(r => r.status === "Tramitado").length;
  const andd = data.filter(r => r.status === "Em andamento").length;
  const val = data.filter(r => r.status === "Em valida√ß√£o").length;
  const pend = data.filter(r => r.status === "Pendente").length;

  $("k_total").textContent = total;
  $("k_tram").textContent = tram;
  $("k_and").textContent = andd;
  $("k_val").textContent = val;
  $("k_pend").textContent = pend;

  // Status pie
  const statusCounts = {};
  data.forEach(r => {
    statusCounts[r.status] = (statusCounts[r.status] || 0) + 1;
  });

  const ctxStatus = $("pieStatus").getContext("2d");
  pieStatus = new Chart(ctxStatus, {
    type: "doughnut",
    data: {
      labels: Object.keys(statusCounts),
      datasets: [{
        data: Object.values(statusCounts),
        backgroundColor: ["#10b981","#f59e0b","#ef4444","#3b82f6","#94a3b8"]
      }]
    },
    options: {
      plugins: { legend: { position: "bottom" } },
      cutout: "60%"
    }
  });

  // Criticidade pie
  const critCounts = {};
  data.forEach(r => {
    const c = normalizeCrit(r.criticidade);
    critCounts[c] = (critCounts[c] || 0) + 1;
  });

  const ctxCrit = $("pieCrit").getContext("2d");
  pieCrit = new Chart(ctxCrit, {
    type: "doughnut",
    data: {
      labels: Object.keys(critCounts),
      datasets: [{
        data: Object.values(critCounts),
        backgroundColor: ["#10b981","#f59e0b","#ef4444"]
      }]
    },
    options: {
      plugins: { legend: { position: "bottom" } },
      cutout: "60%"
    }
  });

  // Top hospitais
  const hospCounts = {};
  data.forEach(r => {
    hospCounts[r.hospital] = (hospCounts[r.hospital] || 0) + 1;
  });
  const hospSorted = Object.entries(hospCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const ctxHosp = $("barHospitais").getContext("2d");
  barHosp = new Chart(ctxHosp, {
    type: "bar",
    data: {
      labels: hospSorted.map(x=>x[0]),
      datasets: [{
        data: hospSorted.map(x=>x[1]),
        backgroundColor: "#10b981"
      }]
    },
    options: {
      plugins: { legend: { display:false } },
      indexAxis: "y"
    }
  });

  // Top respons√°veis
  const respCounts = {};
  data.forEach(r => {
    respCounts[r.responsavel] = (respCounts[r.responsavel] || 0) + 1;
  });
  const respSorted = Object.entries(respCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const ctxResp = $("barResponsaveis").getContext("2d");
  barResp = new Chart(ctxResp, {
    type: "bar",
    data: {
      labels: respSorted.map(x=>x[0]),
      datasets: [{
        data: respSorted.map(x=>x[1]),
        backgroundColor: "#3b82f6"
      }]
    },
    options: {
      plugins: { legend: { display:false } },
      indexAxis: "y"
    }
  });

  // Dashboard hospital
  const selHosp = $("selHospital");
  if(selHosp && selHosp.value){
    renderHospitalDashboard(selHosp.value);
  }
}

function renderHospitalDashboard(hospital){
  const filtered = data.filter(r => r.hospital === hospital);

  const total = filtered.length;
  const andd = filtered.filter(r => r.status === "Em andamento").length;
  const val = filtered.filter(r => r.status === "Em valida√ß√£o").length;
  const pend = filtered.filter(r => r.status === "Pendente").length;
  const tram = filtered.filter(r => r.status === "Tramitado").length;

  $("h_total").textContent = total;
  $("h_and").textContent = andd;
  $("h_val").textContent = val;
  $("h_pend").textContent = pend;
  $("h_tram").textContent = tram;

  // Status pie hospital
  const statusCounts = {};
  filtered.forEach(r => {
    statusCounts[r.status] = (statusCounts[r.status] || 0) + 1;
  });

  const ctxHStatus = $("pieHStatus").getContext("2d");
  pieHStatus = new Chart(ctxHStatus, {
    type: "doughnut",
    data: {
      labels: Object.keys(statusCounts),
      datasets: [{
        data: Object.values(statusCounts),
        backgroundColor: ["#10b981","#f59e0b","#ef4444","#3b82f6","#94a3b8"]
      }]
    },
    options: {
      plugins: { legend: { position: "bottom" } },
      cutout: "60%"
    }
  });

  // Criticidade pie hospital
  const critCounts = {};
  filtered.forEach(r => {
    const c = normalizeCrit(r.criticidade);
    critCounts[c] = (critCounts[c] || 0) + 1;
  });

  const ctxHCrit = $("pieHCrit").getContext("2d");
  pieHCrit = new Chart(ctxHCrit, {
    type: "doughnut",
    data: {
      labels: Object.keys(critCounts),
      datasets: [{
        data: Object.values(critCounts),
        backgroundColor: ["#10b981","#f59e0b","#ef4444"]
      }]
    },
    options: {
      plugins: { legend: { position: "bottom" } },
      cutout: "60%"
    }
  });

  // Tabela hospital
  const tbody = $("tbodyHospital");
  tbody.innerHTML = filtered.slice(0, 50).map(r => `
    <tr>
      <td>${esc(fmtDate(r.data))}</td>
      <td>${esc(r.numero_processo)}</td>
      <td>${esc(FIXED_SETOR)}</td>
      <td>${esc(r.assunto)}</td>
      <td>${esc(r.destino)}</td>
      <td>${esc(r.responsavel)}</td>
      <td>${esc(r.status)}</td>
      <td>${esc(r.criticidade)}</td>
    </tr>
  `).join("");
}

/** RENDER ALL */
function renderAll(){
  renderTable();
  renderAgTable();
  const activeTab = document.querySelector(".tab.active");
  if(activeTab && activeTab.dataset.page.startsWith("dash")){
    setTimeout(renderDashboards, 50);
  }
}

/** WHATSAPP */
function openWaModal(){
  const filtered = getFilteredForWhatsApp();
  if(!filtered.length){ toast("Nenhum registro encontrado com os filtros atuais."); return; }

  const lines = filtered.map(r => {
    return `‚Ä¢üî¢Processo: ${r.numero_processo}
  ‚Ä¢üè•Hospital: ${r.hospital}
   üìÖ Data: ${(r.data)}
  ‚Ä¢üìÑAssunto: ${r.assunto}
  ‚Ä¢üìåDestino: ${r.destino}
  ‚Ä¢üêíRespons√°vel: ${r.responsavel}
  ‚Ä¢üìäStatus: ${r.status}
  ‚Ä¢‚ö†Ô∏èCriticidade: ${r.criticidade}`;
  });

  waMessageDraft = `Op√°! Vanessa,segue o resumo dos processos diarios:\n\n${lines.join("\n\n")}`;
  $("waPreviewText").value = waMessageDraft;
  $("waCharCount").textContent = `${waMessageDraft.length} caracteres`;
  $("waModal").classList.remove("hidden");
}
function closeWaModal(){ $("waModal").classList.add("hidden"); }
function copyWa(){
  const text = $("waPreviewText").value;
  navigator.clipboard.writeText(text);
  toast("Mensagem copiada!");
}
function openWa(){
  const phone = normalize($("waPhone").value);
  const text = encodeURIComponent($("waPreviewText").value);
  const url = phone ? `https://wa.me/${phone}?text=${text}` : `https://wa.me/?text=${text}`;
  window.open(url, "_blank");
}

/** AG MODAL */
function openAgModal(){
  $("ag_data").value = agTodayISO();
  $("ag_hora").value = "";
  $("ag_hospital").value = "";
  $("ag_responsavel").value = "";
  $("ag_tipo").value = "Visita";
  $("ag_obs").value = "";
  $("agModal").classList.remove("hidden");
}
function closeAgModal(){ $("agModal").classList.add("hidden"); }
async function saveAg(){
  const item = {
    data: $("ag_data").value,
    hora: $("ag_hora").value,
    hospital: $("ag_hospital").value,
    responsavel: normalize($("ag_responsavel").value),
    tipo: $("ag_tipo").value,
    observacao: normalize($("ag_obs").value)
  };
  if(!item.data || !item.hospital || !item.responsavel){
    toast("Informe pelo menos data, hospital e respons√°vel.");
    return;
  }
  setBusy(true);
  try{
    await agInsert(item);
    renderAgTable();
    closeAgModal();
    toast("Agendamento salvo!");
  }finally{
    setBusy(false);
  }
}

/** EVENTS */
document.addEventListener("DOMContentLoaded", async () => {
  initTheme();
  initFixedFields();
  await testConnection();
  await agTryLoadSupabase();
  await loadFromSupabase();

  // Cadastro
  $("btnSalvar").addEventListener("click", onSave);
  $("btnCancelarEdicao").addEventListener("click", onCancelEdit);
  $("btnLimpar").addEventListener("click", clearForm);
  $("btnRecarregar").addEventListener("click", loadFromSupabase);

  // Registro
  $("q").addEventListener("input", renderTable);
  $("btnExport").addEventListener("click", exportCSV);
  $("btnExportAgExcel").addEventListener("click", exportAgExcel);
  $("btnWhatsAppPreview").addEventListener("click", openWaModal);
  $("btnAgendarVisita").addEventListener("click", openAgModal);

  // WhatsApp modal
  $("btnCloseWaModal").addEventListener("click", closeWaModal);
  $("btnCopyWa").addEventListener("click", copyWa);
  $("btnOpenWa").addEventListener("click", openWa);
  $("waPreviewText").addEventListener("input", () => {
    $("waCharCount").textContent = `${$("waPreviewText").value.length} caracteres`;
  });

  // Agendamento modal
  $("btnCloseAgModal").addEventListener("click", closeAgModal);
  $("btnSaveAg").addEventListener("click", saveAg);

  // Import Excel
  $("btnImportExcel").addEventListener("click", importExcel);

  // Dashboard hospital select
  $("selHospital").addEventListener("change", () => {
    destroyCharts();
    renderHospitalDashboard($("selHospital").value);
  });

  // Preenche select hospital no dashboard
  const selHospDash = $("selHospital");
  selHospDash.innerHTML = `<option value="">Selecione um hospital...</option>` +
    HOSPITAIS.map(h => `<option value="${esc(h)}">${esc(h)}</option>`).join("");
});
</script>




<!-- MODAL CALCULADORA -->
<div id="calcModal" class="hidden" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
">
  <div style="
    width: 95%;
    height: 95%;
    background: #0f172a;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
  ">
    <button onclick="closeCalc()" style="
      position:absolute;
      top:10px;
      right:10px;
      z-index:10;
      background:#ef4444;
      color:white;
      border:none;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
    ">‚úñ Fechar</button>

    <iframe 
      src="calculadora_gtec.html"
      style="width:100%; height:100%; border:none;">
    </iframe>
  </div>
</div>
</body>
</html>

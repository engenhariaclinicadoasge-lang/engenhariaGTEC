<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Engenharia Clínica GTEC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fb;
      color: #222;
    }
    header {
      background: #1f2937;
      color: #fff;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    .container {
      display: flex;
      height: calc(100vh - 56px);
    }
    aside {
      width: 220px;
      background: #111827;
      color: #fff;
      padding: 12px;
      box-sizing: border-box;
    }
    aside button {
      width: 100%;
      margin-bottom: 8px;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: #1f2937;
      color: #fff;
      cursor: pointer;
      text-align: left;
    }
    aside button:hover {
      background: #374151;
    }
    main {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .hidden { display: none; }

    .card {
      background: #fff;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .card h2, .card h3 {
      margin-top: 0;
      margin-bottom: 8px;
    }
    .muted {
      color: #6b7280;
      font-size: 14px;
    }
    .grid {
      display: grid;
      gap: 16px;
    }
    .grid.cols-2 {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }
    .kpi {
      background: #f3f4f6;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }
    .kpi .t {
      font-size: 12px;
      color: #6b7280;
    }
    .kpi .v {
      font-size: 22px;
      font-weight: bold;
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f3f4f6;
    }

    input, select, textarea, button.btn {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      box-sizing: border-box;
      margin-bottom: 8px;
    }
    button.btn {
      background: #2563eb;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button.btn:hover {
      background: #1d4ed8;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
    }

    .top-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .btn-secondary {
      background: #10b981;
    }
    .btn-secondary:hover {
      background: #059669;
    }

    .btn-danger {
      background: #ef4444;
    }
    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-gray {
      background: #6b7280;
    }
    .btn-gray:hover {
      background: #4b5563;
    }

    .small {
      font-size: 12px;
    }
  </style>
</head>
<body>

<header>
  <h1>Engenharia Clínica GTEC</h1>
  <div>
    <button class="btn btn-secondary small" onclick="openGemini()">Chat-Gemini</button>
  </div>
</header>

<div class="container">
  <aside>
    <button onclick="showPage('page-cadastro')">Cadastro</button>
    <button onclick="showPage('page-registros')">Registros</button>
    <button onclick="showPage('page-dash-geral')">Dashboard Geral</button>
    <button onclick="showPage('page-dash-hospital')">Dashboard por Hospital</button>
    <button onclick="showPage('page-importacao')">Importação</button>
  </aside>

  <main>

    <!-- ===================== CADASTRO ===================== -->
    <section id="page-cadastro" class="card">
      <h2>Novo Registro</h2>
      <p class="muted">Preencha os dados para criar um novo processo.</p>

      <form id="formCadastro">
        <div class="row">
          <input type="text" id="f_hospital" placeholder="Hospital" required />
          <input type="text" id="f_setor" placeholder="Setor" required />
          <input type="text" id="f_responsavel" placeholder="Responsável" required />
          <input type="text" id="f_protocolo" placeholder="Protocolo" />
          <input type="text" id="f_status" placeholder="Status" required />
          <input type="text" id="f_criticidade" placeholder="Criticidade" required />
        </div>
        <textarea id="f_descricao" placeholder="Descrição" rows="3"></textarea>
        <div class="row">
          <input type="date" id="f_data" />
          <input type="text" id="f_whatsapp" placeholder="WhatsApp (ex: 5511999999999)" />
        </div>

        <div class="top-actions">
          <button type="submit" class="btn">Salvar Registro</button>
          <button type="button" class="btn btn-secondary" onclick="enviarWhatsapp()">Enviar WhatsApp</button>
        </div>
      </form>
    </section>

    <!-- ===================== REGISTROS (NOVA ABA) ===================== -->
    <section id="page-registros" class="hidden">
      <div class="card">
        <h2>Registros</h2>
        <p class="muted">Lista completa dos registros cadastrados.</p>

        <div class="top-actions">
          <input type="text" id="searchInput" placeholder="Buscar por hospital, setor, responsável..." oninput="renderTable()" />
          <button class="btn btn-gray" onclick="carregarDados()">Atualizar</button>
        </div>

        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Hospital</th>
                <th>Setor</th>
                <th>Responsável</th>
                <th>Status</th>
                <th>Criticidade</th>
                <th>Protocolo</th>
                <th>Data</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyRegistros"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===================== DASH GERAL ===================== -->
    <section id="page-dash-geral" class="hidden">
      <div class="grid">
        <div class="card">
          <h2>Dashboard Geral</h2>
          <p class="muted">Visão geral dos processos do GTEC.</p>

          <div class="kpis" style="margin-top:10px;">
            <div class="kpi"><div class="t">Total</div><div class="v" id="k_total">0</div></div>
            <div class="kpi"><div class="t">Tramitados</div><div class="v" id="k_tram">0</div></div>
            <div class="kpi"><div class="t">Em andamento</div><div class="v" id="k_and">0</div></div>
            <div class="kpi"><div class="t">Em validação</div><div class="v" id="k_val">0</div></div>
            <div class="kpi"><div class="t">Pendentes</div><div class="v" id="k_pend">0</div></div>
          </div>
        </div>

        <div class="grid cols-2">
          <div class="card">
            <h3>Distribuição por Status</h3>
            <div style="height:280px;">
              <canvas id="pieStatus"></canvas>
            </div>
          </div>

          <div class="card">
            <h3>Distribuição por Criticidade</h3>
            <div style="height:280px;">
              <canvas id="pieCrit"></canvas>
            </div>
          </div>
        </div>

        <div class="grid cols-2">
          <div class="card">
            <h3>Top Hospitais</h3>
            <div style="height:300px;">
              <canvas id="barHospitais"></canvas>
            </div>
          </div>

          <div class="card">
            <h3>Top Responsáveis</h3>
            <div style="height:300px;">
              <canvas id="barResponsaveis"></canvas>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===================== DASH HOSPITAL ===================== -->
    <section id="page-dash-hospital" class="hidden">
      <div class="grid">
        <div class="card">
          <h2>Dashboard por Hospital</h2>
          <p class="muted">Indicadores filtrados por hospital.</p>

          <div style="margin:10px 0;">
            <label for="selHospital">Hospital:</label>
            <select id="selHospital" onchange="renderDashHospital()"></select>
          </div>

          <div class="kpis" style="margin-top:10px;">
            <div class="kpi"><div class="t">Total</div><div class="v" id="kh_total">0</div></div>
            <div class="kpi"><div class="t">Tramitados</div><div class="v" id="kh_tram">0</div></div>
            <div class="kpi"><div class="t">Em andamento</div><div class="v" id="kh_and">0</div></div>
            <div class="kpi"><div class="t">Em validação</div><div class="v" id="kh_val">0</div></div>
            <div class="kpi"><div class="t">Pendentes</div><div class="v" id="kh_pend">0</div></div>
          </div>
        </div>

        <div class="grid cols-2">
          <div class="card">
            <h3>Status por Hospital</h3>
            <div style="height:280px;">
              <canvas id="pieStatusHosp"></canvas>
            </div>
          </div>

          <div class="card">
            <h3>Criticidade por Hospital</h3>
            <div style="height:280px;">
              <canvas id="pieCritHosp"></canvas>
            </div>
          </div>
        </div>

        <div class="grid cols-2">
          <div class="card">
            <h3>Top Responsáveis</h3>
            <div style="height:300px;">
              <canvas id="barRespHosp"></canvas>
            </div>
          </div>

          <div class="card">
            <h3>Top Setores</h3>
            <div style="height:300px;">
              <canvas id="barSetorHosp"></canvas>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===================== IMPORTAÇÃO ===================== -->
    <section id="page-importacao" class="hidden">
      <div class="card">
        <h2>Importação de Cadastros</h2>
        <p class="muted">Importe registros a partir de um arquivo CSV.</p>

        <input type="file" id="fileImport" accept=".csv" />
        <button class="btn" onclick="importarCSV()">Importar</button>

        <p class="small muted" id="importStatus"></p>
      </div>
    </section>

  </main>
</div>

<script>
  // ===================== SUPABASE =====================
  const SUPABASE_URL = "COLE_SUA_URL_AQUI";
  const SUPABASE_KEY = "COLE_SUA_CHAVE_PUBLICA_AQUI";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ===================== ESTADO GLOBAL =====================
  let data = [];

  let pieStatus, pieCrit, barHosp, barResp;
  let pieStatusHosp, pieCritHosp, barRespHosp, barSetorHosp;

  // ===================== UTILITÁRIOS =====================
  const $ = id => document.getElementById(id);

  function normalize(v){
    return (v || "").toString().trim();
  }

  function destroyIf(chart){
    if(chart){ chart.destroy(); }
    return null;
  }

  function showPage(id){
    document.querySelectorAll("main > section").forEach(sec => sec.classList.add("hidden"));
    $(id).classList.remove("hidden");
    if(id === "page-dash-geral") renderDashboards();
    if(id === "page-dash-hospital") renderDashHospital();
  }

  // ===================== CARREGAMENTO =====================
  async function carregarDados(){
    const { data: rows, error } = await supabase
      .from("registros")
      .select("*")
      .order("id", { ascending: false });

    if(error){
      alert("Erro ao carregar dados: " + error.message);
      return;
    }

    data = rows || [];
    renderTable();
    renderDashboards();
  }

  // ===================== CADASTRO =====================
  $("formCadastro").addEventListener("submit", async (e) => {
    e.preventDefault();

    const registro = {
      hospital: normalize($("f_hospital").value),
      setor: normalize($("f_setor").value),
      responsavel: normalize($("f_responsavel").value),
      protocolo: normalize($("f_protocolo").value),
      status: normalize($("f_status").value),
      criticidade: normalize($("f_criticidade").value),
      descricao: normalize($("f_descricao").value),
      data: $("f_data").value || null,
      whatsapp: normalize($("f_whatsapp").value),
      criado_em: new Date().toISOString()
    };

    const { error } = await supabase.from("registros").insert([registro]);

    if(error){
      alert("Erro ao salvar: " + error.message);
      return;
    }

    e.target.reset();
    alert("Registro salvo com sucesso!");
    carregarDados();
    showPage("page-registros");
  });

  // ===================== WHATSAPP =====================
  function enviarWhatsapp(){
    const numero = normalize($("f_whatsapp").value);
    if(!numero){
      alert("Informe o número de WhatsApp.");
      return;
    }

    const mensagem = encodeURIComponent(
      `Olá! Seguem os dados do registro:\n\n` +
      `Hospital: ${$("f_hospital").value}\n` +
      `Setor: ${$("f_setor").value}\n` +
      `Responsável: ${$("f_responsavel").value}\n` +
      `Status: ${$("f_status").value}\n` +
      `Criticidade: ${$("f_criticidade").value}\n` +
      `Protocolo: ${$("f_protocolo").value}\n` +
      `Descrição: ${$("f_descricao").value}`
    );

    window.open(`https://wa.me/${numero}?text=${mensagem}`, "_blank");
  }

  // ===================== TABELA DE REGISTROS =====================
  function renderTable(){
    const tbody = $("tbodyRegistros");
    tbody.innerHTML = "";

    const termo = normalize($("searchInput")?.value || "").toLowerCase();

    const filtered = data.filter(r => {
      const concat = [
        r.hospital,
        r.setor,
        r.responsavel,
        r.status,
        r.criticidade,
        r.protocolo
      ].join(" ").toLowerCase();
      return concat.includes(termo);
    });

    for(const r of filtered){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.id ?? ""}</td>
        <td>${r.hospital ?? ""}</td>
        <td>${r.setor ?? ""}</td>
        <td>${r.responsavel ?? ""}</td>
        <td>${r.status ?? ""}</td>
        <td>${r.criticidade ?? ""}</td>
        <td>${r.protocolo ?? ""}</td>
        <td>${r.data ?? ""}</td>
        <td>
          <button class="btn btn-danger small" onclick="deletarRegistro(${r.id})">Excluir</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function deletarRegistro(id){
    if(!confirm("Tem certeza que deseja excluir este registro?")) return;

    const { error } = await supabase.from("registros").delete().eq("id", id);
    if(error){
      alert("Erro ao excluir: " + error.message);
      return;
    }

    carregarDados();
  }

  // ===================== IMPORTAÇÃO CSV =====================
  async function importarCSV(){
    const fileInput = $("fileImport");
    const statusEl = $("importStatus");
    if(!fileInput.files.length){
      alert("Selecione um arquivo CSV.");
      return;
    }

    const file = fileInput.files[0];
    const text = await file.text();
    const lines = text.split("\n").filter(l => l.trim());

    if(lines.length < 2){
      alert("Arquivo CSV vazio ou inválido.");
      return;
    }

    const headers = lines[0].split(",").map(h => h.trim().toLowerCase());
    const registros = [];

    for(let i = 1; i < lines.length; i++){
      const values = lines[i].split(",").map(v => v.trim());
      const obj = {};
      headers.forEach((h, idx) => obj[h] = values[idx] || null);
      obj.criado_em = new Date().toISOString();
      registros.push(obj);
    }

    const { error } = await supabase.from("registros").insert(registros);
    if(error){
      alert("Erro ao importar: " + error.message);
      return;
    }

    statusEl.textContent = `Importação concluída: ${registros.length} registros inseridos.`;
    carregarDados();
    showPage("page-registros");
  }

  // ===================== KPIs =====================
  function setKpis(){
    $("k_total").textContent = data.length;
    $("k_tram").textContent = data.filter(r => normalize(r.status).toLowerCase() === "tramitado").length;
    $("k_and").textContent = data.filter(r => normalize(r.status).toLowerCase() === "em andamento").length;
    $("k_val").textContent = data.filter(r => normalize(r.status).toLowerCase() === "em validação").length;
    $("k_pend").textContent = data.filter(r => normalize(r.status).toLowerCase() === "pendente").length;
  }

  function setHospitalKpis(filtered){
    $("kh_total").textContent = filtered.length;
    $("kh_tram").textContent = filtered.filter(r => normalize(r.status).toLowerCase() === "tramitado").length;
    $("kh_and").textContent = filtered.filter(r => normalize(r.status).toLowerCase() === "em andamento").length;
    $("kh_val").textContent = filtered.filter(r => normalize(r.status).toLowerCase() === "em validação").length;
    $("kh_pend").textContent = filtered.filter(r => normalize(r.status).toLowerCase() === "pendente").length;
  }

  // ===================== DASHBOARDS =====================
  function mapCounts(arr, field){
    const map = {};
    arr.forEach(r => {
      const key = normalize(r[field]) || "Não informado";
      map[key] = (map[key] || 0) + 1;
    });
    const labels = Object.keys(map);
    const values = Object.values(map);
    return { labels, values };
  }

  function renderDashboards(){
    setKpis();

    const st = mapCounts(data, "status");
    const cr = mapCounts(data, "criticidade");
    const h  = mapCounts(data, "hospital");
    const rp = mapCounts(data, "responsavel");

    pieStatus = destroyIf(pieStatus);
    pieCrit   = destroyIf(pieCrit);
    barHosp   = destroyIf(barHosp);
    barResp   = destroyIf(barResp);

    const baseOptions = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, position: "bottom" },
        tooltip: { enabled: true },
        title: { display: false }
      }
    };

    if($("pieStatus")){
      pieStatus = new Chart($("pieStatus"), {
        type:"pie",
        data:{ labels: st.labels, datasets:[{ data: st.values }] },
        options: baseOptions
      });
    }
    if($("pieCrit")){
      pieCrit = new Chart($("pieCrit"), {
        type:"pie",
        data:{ labels: cr.labels, datasets:[{ data: cr.values }] },
        options: baseOptions
      });
    }
    if($("barHospitais")){
      const top = { labels: h.labels.slice(0,10), values: h.values.slice(0,10) };
      barHosp = new Chart($("barHospitais"), {
        type:"bar",
        data:{ labels: top.labels, datasets:[{ data: top.values, label: "Processos" }] },
        options: baseOptions
      });
    }
    if($("barResponsaveis")){
      const top = { labels: rp.labels.slice(0,10), values: rp.values.slice(0,10) };
      barResp = new Chart($("barResponsaveis"), {
        type:"bar",
        data:{ labels: top.labels, datasets:[{ data: top.values, label: "Processos" }] },
        options: baseOptions
      });
    }

    const sel = $("selHospital");
    const hospitals = [...new Set(data.map(r => normalize(r.hospital)).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    sel.innerHTML = "";
    const allOpt = document.createElement("option");
    allOpt.value = "__ALL__";
    allOpt.textContent = hospitals.length ? "Todos" : "Sem hospitais ainda";
    sel.appendChild(allOpt);
    for(const name of hospitals){
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    }

    renderDashHospital();
  }

  function renderDashHospital(){
    const sel = $("selHospital");
    const hospital = sel.value;
    const filtered = hospital==="__ALL__" ? data : data.filter(r => normalize(r.hospital)===hospital);

    setHospitalKpis(filtered);

    const st = mapCounts(filtered, "status");
    const cr = mapCounts(filtered, "criticidade");
    const rp = mapCounts(filtered, "responsavel");
    const se = mapCounts(filtered, "setor");

    pieStatusHosp = destroyIf(pieStatusHosp);
    pieCritHosp   = destroyIf(pieCritHosp);
    barRespHosp   = destroyIf(barRespHosp);
    barSetorHosp  = destroyIf(barSetorHosp);

    const baseOptions = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, position: "bottom" },
        tooltip: { enabled: true },
        title: { display: false }
      }
    };

    if($("pieStatusHosp")){
      pieStatusHosp = new Chart($("pieStatusHosp"), {
        type:"pie",
        data:{ labels: st.labels, datasets:[{ data: st.values }] },
        options: baseOptions
      });
    }
    if($("pieCritHosp")){
      pieCritHosp = new Chart($("pieCritHosp"), {
        type:"pie",
        data:{ labels: cr.labels, datasets:[{ data: cr.values }] },
        options: baseOptions
      });
    }
    if($("barRespHosp")){
      const top = { labels: rp.labels.slice(0,10), values: rp.values.slice(0,10) };
      barRespHosp = new Chart($("barRespHosp"), {
        type:"bar",
        data:{ labels: top.labels, datasets:[{ data: top.values, label: "Processos" }] },
        options: baseOptions
      });
    }
    if($("barSetorHosp")){
      const top = { labels: se.labels.slice(0,10), values: se.values.slice(0,10) };
      barSetorHosp = new Chart($("barSetorHosp"), {
        type:"bar",
        data:{ labels: top.labels, datasets:[{ data: top.values, label: "Processos" }] },
        options: baseOptions
      });
    }
  }

  // ===================== CHAT GEMINI =====================
  function openGemini(){
    const win = window.open("https://gemini.google.com/app?hl=pt-BR", "gemini", "width=420,height=650,resizable=yes,scrollbars=yes");
    if(win){ win.focus(); }
  }

  // ===================== INICIALIZAÇÃO =====================
  showPage("page-cadastro");
  carregarDados();
</script>

</body>
</html>

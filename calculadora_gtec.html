<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Calculadora RDC</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; background:#0f172a; color:white; padding:20px }
.card { background:#1e293b; padding:20px; border-radius:8px; margin-bottom:20px }
input, select { width:100%; padding:8px; margin-bottom:10px }
button { padding:10px; cursor:pointer; background:#10b981; color:white; border:none; border-radius:5px }
button:hover { opacity:0.9 }
table { width:100%; margin-top:10px; border-collapse: collapse }
td, th { padding:8px; border-bottom:1px solid #334155 }
.badge { background:#334155; padding:3px 6px; border-radius:4px }
.qty { color:#10b981; font-weight:bold }
.top-bar { display:flex; justify-content:space-between; align-items:center }
</style>
</head>

<body>

<div class="card">
<h2>ParÃ¢metros</h2>

<label>Enfermaria</label>
<input type="number" id="n_enf" value="0" oninput="calcular()">

<label>UTI</label>
<input type="number" id="n_uti" value="0" oninput="calcular()">

<label>Centro CirÃºrgico</label>
<input type="number" id="n_cc" value="0" oninput="calcular()">

<label>EmergÃªncia</label>
<input type="number" id="n_emerg" value="0" oninput="calcular()">

</div>

<div class="card">

<div class="top-bar">
<h2>Resultado</h2>
<button onclick="exportarExcel()">ðŸ“Š Exportar Excel</button>
</div>

<table id="resultTable">
<thead>
<tr>
<th>Equipamento</th>
<th>Setor</th>
<th>Regra</th>
<th>Qtd</th>
</tr>
</thead>
<tbody id="tbodyResults"></tbody>
</table>

</div>

<div class="card">
<h2>Nova Regra</h2>

<input id="new_eq" placeholder="Equipamento">
<input id="new_setor" placeholder="Setor">

<select id="new_regra">
<option value="1/leito">1/leito</option>
<option value="1/sala">1/sala</option>
<option value="4/leito">4/leito</option>
<option value="1/unidade">1/unidade</option>
<option value="1/10">1/10</option>
<option value="fixo">fixo</option>
</select>

<button onclick="addRule()">Salvar</button>

</div>

<script>

// ================= SUPABASE =================
const SUPABASE_URL = "https://aykvdakgvugxuurioqum.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5a3ZkYWtndnVneHV1cmlvcXVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MTA1OTIsImV4cCI6MjA4NjE4NjU5Mn0.T3HPPYsmy3-Xi9aBmdkJEWyy6RKqWvSWLtYzKyfwFSg";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let REGRAS_DB = [];

// ================= CALCULAR =================
function calcular() {

const inputs = {
Enfermaria: parseInt(document.getElementById("n_enf").value) || 0,
UTI: parseInt(document.getElementById("n_uti").value) || 0,
CC: parseInt(document.getElementById("n_cc").value) || 0,
Emergencia: parseInt(document.getElementById("n_emerg").value) || 0
};

const tbody = document.getElementById("tbodyResults");
tbody.innerHTML = "";

REGRAS_DB.forEach(r => {

let base = inputs[r.setor] || 0;
let qtd = 0;

if(base > 0){

switch(r.regra){
case "1/leito":
case "1/sala":
qtd = base;
break;

case "4/leito":
qtd = base * 4;
break;

case "1/unidade":
qtd = 1;
break;

case "1/10":
qtd = Math.ceil(base/10);
break;

case "fixo":
qtd = 1;
break;
}

tbody.innerHTML += `
<tr>
<td>${r.eq}</td>
<td><span class="badge">${r.setor}</span></td>
<td>${r.regra}</td>
<td class="qty">${qtd}</td>
</tr>
`;
}

});
}

// ================= EXPORTAR =================
function exportarExcel(){

const table = document.getElementById("resultTable");

if(!table){
alert("Nada para exportar");
return;
}

const wb = XLSX.utils.table_to_book(table, {sheet: "Dimensionamento"});
XLSX.writeFile(wb, "Dimensionamento_Hospitalar.xlsx");

}

// ================= ADICIONAR =================
async function addRule(){

const eq = document.getElementById("new_eq").value;
const setor = document.getElementById("new_setor").value;
const regra = document.getElementById("new_regra").value;

if(!eq || !setor){
alert("Preencha os campos");
return;
}

const { error } = await sb.from("equipamentos_regras").insert({
equipamento: eq,
setor: setor,
regra_quantidade: regra
});

if(error){
alert("Erro: " + error.message);
}else{
alert("Salvo!");
loadDbRules();
}

}

// ================= CARREGAR =================
async function loadDbRules(){

try{

const { data, error } = await sb.from("equipamentos_regras").select("*");

if(error){
console.error(error);
return;
}

REGRAS_DB = [];

if(data){
data.forEach(d=>{
REGRAS_DB.push({
eq: d.equipamento,
setor: d.setor,
regra: d.regra_quantidade
});
});
}

calcular();

}catch(e){
console.error("Erro geral:", e);
}

}

// ================= INIT =================
document.addEventListener("DOMContentLoaded", ()=>{
loadDbRules();
});

</script>

</body>
</html>

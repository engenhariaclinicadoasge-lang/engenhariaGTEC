<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Processos (Supabase + Excel)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg0:#070c16; --bg1:#0b1220;
      --card: rgba(17,26,46,.9);
      --card2: rgba(10,18,38,.6);
      --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b;
      --line:#24324f; --chip:#0f1a33; --input:#0a1226;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --headerbg: rgba(11,18,32,.85);
      --overlay: rgba(0,0,0,.55);
    }
    html[data-theme="light"]{
      --bg0:#f6f8ff; --bg1:#eef2ff;
      --card: rgba(255,255,255,.95);
      --card2: rgba(255,255,255,.9);
      --muted:#475569; --text:#0f172a;
      --accent:#16a34a; --danger:#dc2626; --warn:#b45309;
      --line:#d8dee9; --chip:#eef2ff; --input:#ffffff;
      --shadow: 0 10px 25px rgba(2,6,23,.08);
      --headerbg: rgba(255,255,255,.85);
      --overlay: rgba(15,23,42,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,var(--bg0) 0%, var(--bg1) 35%, var(--bg1) 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:var(--headerbg); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:16px;}
    .topbar{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.35);
      display:grid; place-items:center; color:var(--accent);
      font-weight:800;
    }
    .brand h1{font-size:16px; margin:0}
    .brand p{margin:0; color:var(--muted); font-size:12px}
    nav{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .tab{
      padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background:transparent; color:var(--text); cursor:pointer; font-weight:600;
    }
    .tab.active{background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.35);}

    main{padding:18px 0 40px;}
    .grid{display:grid; gap:14px;}
    .grid.cols-2{grid-template-columns:repeat(2, minmax(0,1fr));}
    .grid.cols-3{grid-template-columns:repeat(3, minmax(0,1fr));}
    @media (max-width:900px){ .grid.cols-2, .grid.cols-3{grid-template-columns:1fr;} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{margin:0 0 10px; font-size:14px}
    .muted{color:var(--muted); font-size:12px}

    label{display:block; font-size:12px; color:var(--muted); margin:8px 0 6px;}
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      background:var(--input);
      border:1px solid var(--line);
      border-radius:12px;
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color:rgba(34,197,94,.6);
      box-shadow:0 0 0 3px rgba(34,197,94,.12);
    }
    input[readonly]{
      opacity:.95;
      cursor:not-allowed;
    }

    .row{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px;}
    @media (max-width:700px){ .row{grid-template-columns:1fr;} }

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--input);
      color:var(--text);
      cursor:pointer;
      font-weight:700;
    }
    button.primary{background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.35);}
    button.danger{background:rgba(239,68,68,.10); border-color:rgba(239,68,68,.35);}
    button.ghost{background:transparent;}
    button:hover{filter:brightness(1.05);}
    button:disabled{opacity:.6; cursor:not-allowed;}

    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden;}
    thead th{
      text-align:left; font-size:12px; color:var(--muted);
      padding:10px 10px; border-bottom:1px solid var(--line);
      position:sticky; top:0; background:var(--card);
      white-space:nowrap;
    }
    tbody td{
      padding:10px 10px; border-bottom:1px solid rgba(36,50,79,.35);
      font-size:13px; vertical-align:top;
    }
    tbody tr:hover{background:rgba(127,127,127,.06);}

    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      background:var(--chip);
      border:1px solid rgba(148,163,184,.22);
      font-size:12px;
      white-space:nowrap;
    }
    .kpis{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
      gap:12px;
    }
    .kpi{
      padding:12px; border-radius:18px; border:1px solid var(--line);
      background:var(--card2);
    }
    .kpi .v{font-size:22px; font-weight:900; margin-top:6px;}
    .kpi .t{font-size:12px; color:var(--muted)}

    .chart{
      width:100%; min-height:320px; border-radius:18px; border:1px solid var(--line);
      background:var(--card2);
      padding:12px;
    }
    .chart h3{margin:0 0 8px; font-size:13px;}

    .notice{
      padding:10px 12px; border-radius:14px;
      background:rgba(245,158,11,.10);
      border:1px solid rgba(245,158,11,.30);
      color:inherit;
      font-size:12px;
    }

    .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .search{min-width:260px;}
    .hidden{display:none !important;}
    .small{font-size:12px;}
    .divider{height:1px; background:var(--line); margin:10px 0;}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(10,18,38,.06);
      font-size:12px; color:var(--muted);
    }
    html[data-theme="dark"] .pill{ background:rgba(10,18,38,.4); }
    .ok{color:#16a34a}
    .bad{color:#dc2626}

    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; justify-content:space-between;
      margin-top:10px;
    }
    .toolbar .group{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;}
    .w240{min-width:240px;}
    .w200{min-width:200px;}

    .modal-overlay{
      position:fixed; inset:0;
      background:var(--overlay);
      display:flex; align-items:center; justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(820px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }
    .modal-header h3{margin:0; font-size:14px;}
    .modal-body{padding:14px;}
    .modal-footer{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      padding:12px 14px;
      border-top:1px solid var(--line);
    }
    textarea#waPreviewText{
      min-height:260px;
      resize:vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      line-height:1.4;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">CP</div>
        <div>
          <h1>Controle de Processos</h1>
          <p>Supabase + Importa√ß√£o Excel + Dashboards com gr√°ficos</p>
        </div>
      </div>

      <div class="right">
        <div class="pill" id="connStatus">Conex√£o: <b class="bad">n√£o verificada</b></div>
        <button id="btnTheme" class="ghost" title="Alternar tema">üåô/‚òÄÔ∏è Tema</button>
      </div>

      <nav>
        <button class="tab active" data-page="cadastro">Cadastro</button>
        <button class="tab" data-page="dash-geral">Dashboard Geral</button>
        <button class="tab" data-page="dash-hospital">Dashboard por Hospital</button>
      </nav>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- ===================== CADASTRO ===================== -->
  <section id="page-cadastro" class="grid cols-2">
    <div class="card">
      <h2>Novo registro</h2>
      <p class="muted">Setor fixo em <b>GTEC - Grupo Tecnico de Engenharia Clinica</b>.</p>

      <div class="row">
        <div>
          <label>N√∫mero do processo</label>
          <input id="f_numero" placeholder="Ex: 2026/000123" />
        </div>
        <div>
          <label>Setor (fixo)</label>
          <input id="f_setor" readonly />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Data</label>
          <input id="f_data" type="date" />
        </div>
        <div>
          <label>Hospital</label>
          <select id="f_hospital"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Assunto</label>
          <input id="f_assunto" placeholder="Ex: Termo de Refer√™ncia" />
        </div>
        <div>
          <label>Destino</label>
          <input id="f_destino" placeholder="Ex: Setor Y / SEI / Comiss√£o" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Respons√°vel</label>
          <input id="f_responsavel" placeholder="Ex: Jo√£o Pedro" />
        </div>
        <div>
          <label>Status</label>
          <select id="f_status">
            <option value="Em andamento">Em andamento</option>
            <option value="Em valida√ß√£o">Em valida√ß√£o</option>
            <option value="Pendente">Pendente</option>
            <option value="Tramitado">Tramitado</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Criticidade</label>
          <select id="f_criticidade">
            <option value="Baixa">Baixa</option>
            <option value="M√©dia" selected>M√©dia</option>
            <option value="Alta">Alta</option>
          </select>
          <div class="muted">Entra no dashboard.</div>
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="pill">‚ÄúEditar‚Äù s√≥ aparece se status = <b>Em andamento</b></div>
        </div>
      </div>

      <div class="actions">
        <button class="primary" id="btnSalvar">Salvar</button>
        <button class="ghost" id="btnLimpar">Limpar</button>
        <button class="ghost" id="btnRecarregar" title="Recarrega do Supabase">Recarregar</button>
      </div>

      <div id="editBanner" class="notice hidden" style="margin-top:12px;">
        Editando um registro (somente quando Status = <b>Em andamento</b>). Clique em <b>Salvar</b> para atualizar.
        <button id="btnCancelarEdicao" class="ghost small" style="margin-left:10px;">Cancelar edi√ß√£o</button>
      </div>

      <div class="divider"></div>

      <h2>Importar Excel (.xlsx)</h2>
      <p class="muted">
        Colunas (linha 1): <b>numero_processo, data, hospital, assunto, destino, responsavel, status, criticidade</b><br>
        Observa√ß√£o: <b>setor √© fixo</b> e ser√° aplicado automaticamente como <b>GTEC - Grupo Tecnico de Engenharia Clinica</b>.
      </p>

      <div class="row">
        <div>
          <label>Arquivo Excel</label>
          <input type="file" id="fileXLSX" accept=".xlsx,.xls" />
        </div>
        <div>
          <label>Planilha/Aba</label>
          <input id="sheetName" placeholder="Vazio = 1¬™ aba" />
        </div>
      </div>

      <div class="actions">
        <button id="btnImportExcel">Importar Excel para Supabase</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap;">
        <div>
          <h2>Registros</h2>
          <p class="muted">Busca + exporta√ß√£o + a√ß√µes.</p>
        </div>
        <div class="right">
          <input id="q" class="search" placeholder="Buscar por processo, hospital, respons√°vel..." />
          <button id="btnExport" title="Exporta CSV">Exportar CSV</button>
        </div>
      </div>

      <div class="toolbar">
        <div class="group">
          <div class="w240">
            <label>Exportar por respons√°vel</label>
            <select id="selResponsavelWA"></select>
          </div>
          <div class="w200">
            <label>Telefone (opcional)</label>
            <input id="waPhone" placeholder="55DDDNUMERO (sem +)" />
            <div class="muted">Ex: 5591999999999</div>
          </div>
        </div>
        <div class="group">
          <button id="btnWhatsAppPreview" class="primary">Pr√©-visualizar</button>
        </div>
      </div>

      <div class="divider"></div>

      <div style="max-height:520px; overflow:auto; border-radius:14px; border:1px solid var(--line);">
        <table>
          <thead>
            <tr>
              <th>Processo</th>
              <th>Setor</th>
              <th>Data</th>
              <th>Hospital</th>
              <th>Assunto</th>
              <th>Destino</th>
              <th>Respons√°vel</th>
              <th>Status</th>
              <th>Criticidade</th>
              <th style="width:190px;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p class="muted" style="margin-top:10px;" id="countInfo"></p>
      <p class="muted" id="lastSync"></p>
    </div>
  </section>

  <!-- ===================== DASH GERAL ===================== -->
  <section id="page-dash-geral" class="hidden">
    <div class="grid">
      <div class="card">
        <h2>Dashboard Geral</h2>
        <p class="muted">Resumo autom√°tico baseado nos registros do Supabase.</p>

        <div class="kpis" style="margin-top:10px;">
          <div class="kpi"><div class="t">Total</div><div class="v" id="k_total">0</div></div>
          <div class="kpi"><div class="t">Tramitados</div><div class="v" id="k_tram">0</div></div>
          <div class="kpi"><div class="t">Em andamento</div><div class="v" id="k_and">0</div></div>
          <div class="kpi"><div class="t">Em valida√ß√£o</div><div class="v" id="k_val">0</div></div>
          <div class="kpi"><div class="t">Pendentes</div><div class="v" id="k_pend">0</div></div>
        </div>
      </div>

      <div class="grid cols-2">
        <div class="chart"><h3>Status (Pizza)</h3><canvas id="pieStatus"></canvas></div>
        <div class="chart"><h3>Criticidade (Pizza)</h3><canvas id="pieCrit"></canvas></div>
      </div>

      <div class="grid cols-2">
        <div class="chart"><h3>Top Hospitais (Barra)</h3><canvas id="barHospitais"></canvas></div>
        <div class="chart"><h3>Top Respons√°veis (Barra)</h3><canvas id="barResponsaveis"></canvas></div>
      </div>
    </div>
  </section>

  <!-- ===================== DASH HOSPITAL ===================== -->
  <section id="page-dash-hospital" class="hidden">
    <div class="grid">
      <div class="card">
        <div style="display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap;">
          <div>
            <h2>Dashboard por Hospital</h2>
            <p class="muted">Filtre e veja resumo do hospital selecionado.</p>
          </div>
          <div style="min-width:280px;">
            <label>Selecionar hospital</label>
            <select id="selHospital"></select>
          </div>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="t">Total</div><div class="v" id="h_total">0</div></div>
        <div class="kpi"><div class="t">Em andamento</div><div class="v" id="h_and">0</div></div>
        <div class="kpi"><div class="t">Em valida√ß√£o</div><div class="v" id="h_val">0</div></div>
        <div class="kpi"><div class="t">Pendentes</div><div class="v" id="h_pend">0</div></div>
        <div class="kpi"><div class="t">Tramitados</div><div class="v" id="h_tram">0</div></div>
      </div>

      <div class="grid cols-2">
        <div class="chart"><h3>Criticidade (no hospital) - Pizza</h3><canvas id="pieHCrit"></canvas></div>
        <div class="chart"><h3>Status (no hospital) - Pizza</h3><canvas id="pieHStatus"></canvas></div>
      </div>

      <div class="card">
        <h2>√öltimos registros do hospital</h2>
        <p class="muted">Ordenado por data (mais recente primeiro).</p>
        <div style="max-height:420px; overflow:auto; border-radius:14px; border:1px solid var(--line); margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>Data</th><th>Processo</th><th>Setor</th><th>Assunto</th><th>Destino</th><th>Respons√°vel</th><th>Status</th><th>Criticidade</th>
              </tr>
            </thead>
            <tbody id="tbodyHospital"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- MODAL WhatsApp -->
<div id="waModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-header">
      <h3>Pr√©via da mensagem (WhatsApp)</h3>
      <button class="ghost" id="btnCloseWaModal">‚úï</button>
    </div>
    <div class="modal-body">
      <p class="muted" style="margin-top:0;">Edite antes de enviar ou copie para outro lugar.</p>
      <label>Texto</label>
      <textarea id="waPreviewText"></textarea>
      <div class="muted" id="waCharCount" style="margin-top:6px;"></div>
    </div>
    <div class="modal-footer">
      <button id="btnCopyWa" class="ghost">Copiar</button>
      <button id="btnOpenWa" class="primary">Abrir WhatsApp</button>
    </div>
  </div>
</div>

<script>
/** SUPABASE */
const SUPABASE_URL = "https://aykvdakgvugxuurioqum.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5a3ZkYWtndnVneHV1cmlvcXVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MTA1OTIsImV4cCI6MjA4NjE4NjU5Mn0.T3HPPYsmy3-Xi9aBmdkJEWyy6RKqWvSWLtYzKyfwFSg";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/** SETOR FIXO */
const FIXED_SETOR = "GTEC - Grupo Tecnico de Engenharia Clinica.";

/** LISTA FIXA DE HOSPITAIS */
const HOSPITAIS = [
  "POLICL√çNICA DE TUCURU√ç",
  "POLICLINICA METROPOLITANA DE BEL√âM",
  "HOSPITAL DE CLINICAS GASPAR VIANA",
  "HOSPITAL GERAL DE IPIXUNA DO PARA",
  "HOSPITAL GERAL DE TAILANDIA",
  "HOSPITAL JEAN BITAR",
  "HOSPITAL METROPOLITANO DE URG√äNCIA E EMERG√äNCIA",
  "HOSPITAL ONCOL√ìGICO INFANTIL OCT√ÅVIO LOBO",
  "HOSPITAL OPHIR LOYOLA",
  "HOSPITAL P√öBLICO ESTADUAL GALILEU",
  "HOSPITAL P√öBLICO GERAL DOS CASTELO DOS SONHOS",
  "HOSPITAL REGIONAL DE CAMETA",
  "HOSPITAL REGIONAL DE CONCEICAO DO ARAGUAIA",
  "HOSPITAL REGIONAL DE TUCURUI",
  "HOSPITAL REGIONAL DO BAIXO AMAZONAS DO PA DR WALDEMAR PENNA",
  "HOSPITAL SANTA ROSA",
  "HOSPITAL REGIONAL DO SUDESTE DO PARA DR GERALDO VELOSO",
  "HOSPITAL REGIONAL DR OLIMPIO CARDOSO DA SILVEIRA",
  "HOSPITAL REGIONAL P√öBLICO DA TRANSAMAZ√îNICA",
  "HOSPITAL REGIONAL P√öBLICO DE CASTANHAL",
  "HOSPITAL REGIONAL P√öBLICO DO ARAGUAIA",
  "HOSPITAL REGIONAL PUBLICO DO LESTE DO PARA",
  "HOSPITAL REGIONAL PUBLICO DO MARAJO",
  "HOSPITAL REGIONAL P√öBLICO DO TAPAJOS ITAITUBA",
  "HOSPITAL REGIONAL P√öBLICO DOS CAETES DR JORGE NETO DA COSTA",
  "HOSPITAL REGIONAL PUBLICO DR ABELARDO SANTOS",
  "HOSPITAL REGIONAL P√öBLICO MATERNO INFANTIL DE BARCARENA",
  "Centro Integrado de Inclus√£o e Reabilita√ß√£o - CIIR",
  "HOSPITAL DA MULHER SENHORA DE NAZAR√â",
  "HOSPITAL MATERNO INFANTIL DE ALTAMIRA",
  "HOSPITAL MATERNO INFANTIL DE BREVES",
  "HOSPITAL MATERNO INFANTIL DE MARAB√Å",
  "HOSPITAL MATERNO INFANTIL DE SANTAR√âM",
  "HOSPITAL MUNICIPAL DE RIO MARIA",
  "HOSPITAL PRONTO SOCORRO",
  "POLICL√çNICA DE ALTAMIRA",
  "POLICL√çNICA DE BREVES",
  "POLICLINICA DE CAPANEMA",
  "POLICL√çNICA DE MARAB√Å",
  "POLICL√çNICA DE SANTAR√âM"
];

/** STATE */
let data = [];
let editingId = null;
let pieStatus, pieCrit, barHosp, barResp;
let waMessageDraft = "";

/** HELPERS */
const $ = (id) => document.getElementById(id);
const esc = (s) => (s ?? "").toString().replace(/[&<>"']/g, m => ({
  "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
}[m]));
function normalize(s){ return (s ?? "").toString().trim(); }
function toast(msg){ alert(msg); }
function setBusy(isBusy){
  ["btnSalvar","btnLimpar","btnRecarregar","btnImportExcel","btnExport","btnWhatsAppPreview"].forEach(id=>{
    const el = $(id); if(el) el.disabled = isBusy;
  });
}
function fmtDate(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  return (d && m && y) ? `${d}/${m}/${y}` : iso;
}
function connBadge(ok){
  const el = $("connStatus");
  el.innerHTML = ok ? `Conex√£o: <b class="ok">OK</b>` : `Conex√£o: <b class="bad">ERRO</b>`;
}
function normalizeCrit(v){
  const x = normalize(v);
  if(!x) return "M√©dia";
  const low = x.toLowerCase();
  if(low.includes("alta")) return "Alta";
  if(low.includes("baixa")) return "Baixa";
  return "M√©dia";
}
function normalizeStatus(v){
  const x = normalize(v);
  if(!x) return "Em andamento";
  const low = x.toLowerCase();
  if(low.includes("val")) return "Em valida√ß√£o";
  if(low.includes("pend")) return "Pendente";
  if(low.includes("tram")) return "Tramitado";
  if(low.includes("and")) return "Em andamento";
  if(low.includes("conclu")) return "Tramitado";
  return x;
}

/** THEME */
const THEME_KEY = "cp_theme_v3";
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem(THEME_KEY, theme);
}
function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  if(saved === "light" || saved === "dark") applyTheme(saved);
}
function toggleTheme(){
  const current = document.documentElement.getAttribute("data-theme") || "dark";
  applyTheme(current === "dark" ? "light" : "dark");
}

/** INIT selects */
function initFixedFields(){
  $("f_setor").value = FIXED_SETOR;

  // cadastro hospital select
  const selHosp = $("f_hospital");
  selHosp.innerHTML = "";
  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = "Selecione um hospital...";
  selHosp.appendChild(ph);

  for(const h of HOSPITAIS){
    const opt = document.createElement("option");
    opt.value = h;
    opt.textContent = h;
    selHosp.appendChild(opt);
  }
}

/** FORM */
function getForm(){
  return {
    numero_processo: normalize($("f_numero").value),
    setor: FIXED_SETOR, // fixo
    data: $("f_data").value || "",
    hospital: $("f_hospital").value || "",
    assunto: normalize($("f_assunto").value),
    destino: normalize($("f_destino").value),
    responsavel: normalize($("f_responsavel").value),
    status: $("f_status").value || "Em andamento",
    criticidade: $("f_criticidade").value || "M√©dia"
  };
}
function setForm(r){
  $("f_numero").value = r?.numero_processo || "";
  $("f_setor").value = FIXED_SETOR;
  $("f_data").value = r?.data || "";
  $("f_hospital").value = r?.hospital || "";
  $("f_assunto").value = r?.assunto || "";
  $("f_destino").value = r?.destino || "";
  $("f_responsavel").value = r?.responsavel || "";
  $("f_status").value = r?.status || "Em andamento";
  $("f_criticidade").value = r?.criticidade || "M√©dia";
}
function clearForm(){ setForm(null); }
function validate(r){
  if(!r.numero_processo) return "Informe o n√∫mero do processo.";
  if(!r.data) return "Informe a data.";
  if(!r.hospital) return "Selecione o hospital.";
  if(!r.assunto) return "Informe o assunto.";
  if(!r.destino) return "Informe o destino.";
  if(!r.responsavel) return "Informe o respons√°vel.";
  return null;
}

/** SUPABASE */
async function testConnection(){
  try{
    const { error } = await sb.from("processos").select("id").limit(1);
    connBadge(!error);
    if(error) console.error(error);
  }catch(e){
    connBadge(false);
    console.error(e);
  }
}
async function loadFromSupabase(){
  setBusy(true);
  try{
    const { data: rows, error } = await sb
      .from("processos")
      .select("*")
      .order("created_at", { ascending: false });

    if(error) throw error;

    data = (rows || []).map(r => ({
      ...r,
      setor: FIXED_SETOR,
      status: normalizeStatus(r.status),
      criticidade: r.criticidade ? normalizeCrit(r.criticidade) : "M√©dia"
    }));

    $("lastSync").textContent = `√öltima atualiza√ß√£o: ${new Date().toLocaleString()}`;
    renderAll();
  }catch(e){
    console.error(e);
    toast("Erro ao carregar do Supabase (RLS/Policies).");
  }finally{
    setBusy(false);
  }
}
async function insertRecord(record){
  const { data: row, error } = await sb.from("processos").insert({ ...record }).select("*").single();
  if(error) throw error;
  return row;
}
async function updateRecord(id, record){
  const payload = { ...record, updated_at: new Date().toISOString() };
  const { data: row, error } = await sb.from("processos").update(payload).eq("id", id).select("*").single();
  if(error) throw error;
  return row;
}
async function deleteRecord(id){
  const { error } = await sb.from("processos").delete().eq("id", id);
  if(error) throw error;
}

/** TABLE */
function renderTable(){
  const q = normalize($("q").value).toLowerCase();
  const tbody = $("tbody");

  const filtered = data.filter(r => {
    if(!q) return true;
    const blob = [
      r.numero_processo, r.setor, r.data, r.hospital,
      r.assunto, r.destino, r.responsavel, r.status, r.criticidade
    ].join(" ").toLowerCase();
    return blob.includes(q);
  });

  tbody.innerHTML = filtered.map(r => {
    const canEdit = (r.status === "Em andamento");
    return `
      <tr>
        <td><span class="chip">${esc(r.numero_processo)}</span></td>
        <td>${esc(FIXED_SETOR)}</td>
        <td>${esc(fmtDate(r.data))}</td>
        <td>${esc(r.hospital)}</td>
        <td>${esc(r.assunto)}</td>
        <td>${esc(r.destino)}</td>
        <td>${esc(r.responsavel)}</td>
        <td>${esc(r.status)}</td>
        <td>${esc(r.criticidade || "M√©dia")}</td>
        <td>
          ${canEdit ? `<button class="ghost small" onclick="onEdit('${r.id}')">Editar</button>` : ``}
          <button class="danger small" onclick="onDelete('${r.id}')">Excluir</button>
        </td>
      </tr>
    `;
  }).join("");

  $("countInfo").textContent = `Mostrando ${filtered.length} de ${data.length} registros.`;
}

window.onEdit = (id) => {
  const r = data.find(x => x.id === id);
  if(!r) return;
  if(r.status !== "Em andamento"){
    toast("S√≥ √© permitido editar quando o status estiver 'Em andamento'.");
    return;
  }
  editingId = id;
  setForm(r);
  $("editBanner").classList.remove("hidden");
  goPage("cadastro");
};

window.onDelete = async (id) => {
  const r = data.find(x => x.id === id);
  if(!r) return;
  if(!confirm(`Excluir o processo "${r.numero_processo}"?`)) return;

  setBusy(true);
  try{
    await deleteRecord(id);
    data = data.filter(x => x.id !== id);
    if(editingId === id){
      editingId = null;
      $("editBanner").classList.add("hidden");
      clearForm();
    }
    renderAll();
  }catch(e){
    console.error(e);
    toast("Erro ao excluir (RLS/Policies).");
  }finally{
    setBusy(false);
  }
};

async function onSave(){
  const r = getForm();
  const err = validate(r);
  if(err){ toast(err); return; }

  setBusy(true);
  try{
    if(editingId){
      const current = data.find(x => x.id === editingId);
      if(current && current.status !== "Em andamento"){
        toast("N√£o foi poss√≠vel salvar: o status n√£o est√° mais 'Em andamento'.");
        return;
      }
      const updated = await updateRecord(editingId, r);
      data = data.map(x => x.id === editingId ? { ...updated, setor: FIXED_SETOR, criticidade: normalizeCrit(updated.criticidade||"M√©dia"), status: normalizeStatus(updated.status)} : x);
      editingId = null;
      $("editBanner").classList.add("hidden");
    }else{
      const inserted = await insertRecord(r);
      data.unshift({ ...inserted, setor: FIXED_SETOR, criticidade: normalizeCrit(inserted.criticidade||"M√©dia"), status: normalizeStatus(inserted.status) });
    }
    clearForm();
    renderAll();
    toast("Salvo com sucesso!");
  }catch(e){
    console.error(e);
    toast("Erro ao salvar no Supabase (RLS/Policies).");
  }finally{
    setBusy(false);
  }
}

function onCancelEdit(){
  editingId = null;
  $("editBanner").classList.add("hidden");
  clearForm();
}
function onClear(){
  onCancelEdit();
  clearForm();
}

/** EXPORT CSV */
function exportCSV(){
  if(!data.length){ toast("Sem dados para exportar."); return; }
  const headers = ["numero_processo","setor","data","hospital","assunto","destino","responsavel","status","criticidade"];
  const lines = [
    headers.join(","),
    ...data.map(r => headers.map(h => {
      const v = (r[h] ?? (h==="setor"?FIXED_SETOR:"")).toString().replaceAll('"','""');
      return `"${v}"`;
    }).join(","))
  ];
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "processos.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/** IMPORT EXCEL */
function normalizeHeader(h){
  return normalize(h).toLowerCase().replaceAll(" ", "_").replaceAll("-", "_");
}
function excelDateToISO(v){
  if(typeof v === "string" && /^\d{4}-\d{2}-\d{2}$/.test(v.trim())) return v.trim();
  if(v instanceof Date && !isNaN(v.getTime())){
    const y=v.getFullYear(), m=String(v.getMonth()+1).padStart(2,"0"), d=String(v.getDate()).padStart(2,"0");
    return `${y}-${m}-${d}`;
  }
  if(typeof v === "number"){
    const d = XLSX.SSF.parse_date_code(v);
    if(d){
      const y=d.y, m=String(d.m).padStart(2,"0"), day=String(d.d).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
  }
  if(typeof v === "string" && /^\d{2}\/\d{2}\/\d{4}$/.test(v.trim())){
    const [dd,mm,yyyy]=v.trim().split("/");
    return `${yyyy}-${mm}-${dd}`;
  }
  return "";
}
async function importExcel(){
  const f = $("fileXLSX").files[0];
  if(!f) return toast("Selecione um arquivo Excel (.xlsx).");

  setBusy(true);
  try{
    const buf = await f.arrayBuffer();
    const wb = XLSX.read(buf, { type:"array" });

    const preferred = normalize($("sheetName").value);
    const sheet = preferred && wb.Sheets[preferred] ? wb.Sheets[preferred] : wb.Sheets[wb.SheetNames[0]];
    if(!sheet) throw new Error("Aba n√£o encontrada.");

    const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
    if(!rows.length) return toast("Planilha vazia.");

    const normalizedRows = rows.map(r=>{
      const out = {};
      for(const k of Object.keys(r)) out[normalizeHeader(k)] = r[k];
      return out;
    });

    const payload = normalizedRows.map(r => ({
      numero_processo: normalize(r.numero_processo),
      setor: FIXED_SETOR,
      data: excelDateToISO(r.data),
      hospital: normalize(r.hospital),
      assunto: normalize(r.assunto),
      destino: normalize(r.destino),
      responsavel: normalize(r.responsavel),
      status: normalizeStatus(r.status),
      criticidade: normalizeCrit(r.criticidade)
    })).filter(r => r.numero_processo);

    if(!payload.length) return toast("Nenhuma linha v√°lida. Verifique colunas e dados.");

    const invalid = payload.find(p => !p.data || !p.hospital || !p.assunto || !p.destino || !p.responsavel);
    if(invalid){
      return toast("H√° linhas faltando campos obrigat√≥rios (data/hospital/assunto/destino/responsavel).");
    }

    // valida hospital contra lista (se n√£o estiver, bloqueia)
    const badHosp = payload.find(p => !HOSPITAIS.includes(p.hospital));
    if(badHosp){
      return toast(`Hospital inv√°lido na planilha: "${badHosp.hospital}". Use exatamente um nome da lista.`);
    }

    const chunkSize = 300;
    let insertedTotal = 0;

    for(let i=0; i<payload.length; i+=chunkSize){
      const chunk = payload.slice(i, i+chunkSize);
      const { data: inserted, error } = await sb.from("processos").insert(chunk).select("*");
      if(error) throw error;

      insertedTotal += (inserted?.length || 0);
      if(inserted?.length){
        data = [...inserted.map(x => ({
          ...x,
          setor: FIXED_SETOR,
          status: normalizeStatus(x.status),
          criticidade: normalizeCrit(x.criticidade || "M√©dia")
        })), ...data];
      }
    }

    renderAll();
    toast(`Importa√ß√£o conclu√≠da: ${insertedTotal} registros inseridos no Supabase.`);
  }catch(e){
    console.error(e);
    toast("Erro ao importar Excel (RLS/Policies).");
  }finally{
    setBusy(false);
  }
}

/** DASH */
function mapCounts(list, field){
  const m = new Map();
  for(const r of list){
    const k = normalize(r[field]) || "(vazio)";
    m.set(k, (m.get(k)||0)+1);
  }
  const entries = [...m.entries()].sort((a,b)=>b[1]-a[1]);
  return { labels: entries.map(e=>e[0]), values: entries.map(e=>e[1]) };
}
function destroyIf(chart){ if(chart) chart.destroy(); return null; }
function setKpis(){
  $("k_total").textContent = data.length;
  $("k_tram").textContent = data.filter(r => r.status === "Tramitado").length;
  $("k_and").textContent  = data.filter(r => r.status === "Em andamento").length;
  $("k_val").textContent  = data.filter(r => r.status === "Em valida√ß√£o").length;
  $("k_pend").textContent = data.filter(r => r.status === "Pendente").length;
}

function renderDashboards(){
  setKpis();

  const st = mapCounts(data, "status");
  const cr = mapCounts(data, "criticidade");
  const h  = mapCounts(data, "hospital");
  const rp = mapCounts(data, "responsavel");

  pieStatus = destroyIf(pieStatus);
  pieCrit   = destroyIf(pieCrit);
  barHosp   = destroyIf(barHosp);
  barResp   = destroyIf(barResp);

  if($("pieStatus")){
    pieStatus = new Chart($("pieStatus"), {
      type:"pie",
      data:{ labels: st.labels, datasets:[{ label:"Status", data: st.values }] },
      options:{ responsive:true }
    });
  }
  if($("pieCrit")){
    pieCrit = new Chart($("pieCrit"), {
      type:"pie",
      data:{ labels: cr.labels, datasets:[{ label:"Criticidade", data: cr.values }] },
      options:{ responsive:true }
    });
  }
  if($("barHospitais")){
    const top = { labels: h.labels.slice(0,10), values: h.values.slice(0,10) };
    barHosp = new Chart($("barHospitais"), {
      type:"bar",
      data:{ labels: top.labels, datasets:[{ label:"Top hospitais", data: top.values }] },
      options:{ responsive:true }
    });
  }
  if($("barResponsaveis")){
    const top = { labels: rp.labels.slice(0,10), values: rp.values.slice(0,10) };
    barResp = new Chart($("barResponsaveis"), {
      type:"bar",
      data:{ labels: top.labels, datasets:[{ label:"Top respons√°veis", data: top.values }] },
      options:{ responsive:true }
    });
  }

  // hospital selector (dashboard)
  const sel = $("selHospital");
  const hospitals = [...new Set(data.map(r => normalize(r.hospital)).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  sel.innerHTML = "";
  const allOpt = document.createElement("option");
  allOpt.value = "__ALL__";
  allOpt.textContent = hospitals.length ? "Todos" : "Sem hospitais ainda";
  sel.appendChild(allOpt);
  for(const name of hospitals){
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  }

  renderDashHospital();
}

let pieHCrit, pieHStatus;
function renderDashHospital(){
  const sel = $("selHospital").value;
  let list = data;
  if(sel && sel !== "__ALL__") list = data.filter(r => normalize(r.hospital) === sel);

  $("h_total").textContent = list.length;
  $("h_and").textContent  = list.filter(r => r.status === "Em andamento").length;
  $("h_val").textContent  = list.filter(r => r.status === "Em valida√ß√£o").length;
  $("h_pend").textContent = list.filter(r => r.status === "Pendente").length;
  $("h_tram").textContent = list.filter(r => r.status === "Tramitado").length;

  const crit = mapCounts(list, "criticidade");
  const st   = mapCounts(list, "status");

  pieHCrit = destroyIf(pieHCrit);
  pieHStatus = destroyIf(pieHStatus);

  if($("pieHCrit")){
    pieHCrit = new Chart($("pieHCrit"), {
      type:"pie",
      data:{ labels: crit.labels, datasets:[{ label:"Criticidade", data: crit.values }] },
      options:{ responsive:true }
    });
  }
  if($("pieHStatus")){
    pieHStatus = new Chart($("pieHStatus"), {
      type:"pie",
      data:{ labels: st.labels, datasets:[{ label:"Status", data: st.values }] },
      options:{ responsive:true }
    });
  }

  const sorted = [...list].sort((a,b)=>{
    if(!a.data && !b.data) return 0;
    if(!a.data) return 1;
    if(!b.data) return -1;
    return (b.data||"").localeCompare(a.data||"");
  }).slice(0, 50);

  $("tbodyHospital").innerHTML = sorted.map(r => `
    <tr>
      <td>${esc(fmtDate(r.data))}</td>
      <td><span class="chip">${esc(r.numero_processo)}</span></td>
      <td>${esc(FIXED_SETOR)}</td>
      <td>${esc(r.assunto)}</td>
      <td>${esc(r.destino)}</td>
      <td>${esc(r.responsavel)}</td>
      <td>${esc(r.status)}</td>
      <td>${esc(r.criticidade || "M√©dia")}</td>
    </tr>
  `).join("");
}

/** WhatsApp */
function refreshResponsavelSelect(){
  const sel = $("selResponsavelWA");
  const responsaveis = [...new Set(data.map(r => normalize(r.responsavel)).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  sel.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "__ALL__";
  opt0.textContent = responsaveis.length ? "Todos os respons√°veis" : "Sem dados";
  sel.appendChild(opt0);
  for(const name of responsaveis){
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  }
}
function buildWhatsAppMessage(responsavel){
  const list = responsavel === "__ALL__" ? data : data.filter(r => normalize(r.responsavel) === responsavel);
  if(!list.length) return "";

  const title = responsavel === "__ALL__"
    ? `üìå *Relat√≥rio de Processos (GTEC)*`
    : `üìå *Relat√≥rio de Processos (GTEC) - ${responsavel}*`;

  const critOrder = (c) => c === "Alta" ? 3 : (c === "M√©dia" ? 2 : 1);
  const sorted = [...list].sort((a,b)=>{
    const dc = critOrder(normalizeCrit(b.criticidade)) - critOrder(normalizeCrit(a.criticidade));
    if(dc !== 0) return dc;
    return (b.data||"").localeCompare(a.data||"");
  });

  const lines = sorted.slice(0, 80).map(r => {
    const crit = normalizeCrit(r.criticidade);
    return `‚Ä¢ *${r.numero_processo}* | ${fmtDate(r.data)} | ${r.hospital}\n  Status: ${r.status} | Criticidade: *${crit}*\n  Assunto: ${r.assunto}\n  Destino: ${r.destino}`;
  });

  if(sorted.length > 80) lines.push(`\n(Mostrando 80 de ${sorted.length}. Exporte CSV para lista completa.)`);

  return `${title}\n\n${lines.join("\n\n")}`;
}
function openWaModal(message){
  waMessageDraft = message || "";
  $("waPreviewText").value = waMessageDraft;
  $("waCharCount").textContent = `Caracteres: ${waMessageDraft.length}`;
  $("waModal").classList.remove("hidden");
}
function closeWaModal(){ $("waModal").classList.add("hidden"); }
async function copyWaText(){
  const txt = $("waPreviewText").value || "";
  try{
    await navigator.clipboard.writeText(txt);
    toast("Texto copiado!");
  }catch{
    $("waPreviewText").select();
    document.execCommand("copy");
    toast("Texto copiado!");
  }
}
function openWhatsAppFromModal(){
  const msg = $("waPreviewText").value || "";
  if(!msg.trim()) return toast("Mensagem vazia.");

  const phone = normalize($("waPhone").value).replace(/\D/g,"");
  const encoded = encodeURIComponent(msg);
  const url = phone ? `https://wa.me/${phone}?text=${encoded}` : `https://wa.me/?text=${encoded}`;
  window.open(url, "_blank", "noopener,noreferrer");
}
function previewWhatsApp(){
  const resp = $("selResponsavelWA").value;
  const msg = buildWhatsAppMessage(resp);
  if(!msg) return toast("Sem registros para esse respons√°vel.");
  openWaModal(msg);
}

/** NAV */
function goPage(page){
  document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.page === page));
  $("page-cadastro").classList.toggle("hidden", page !== "cadastro");
  $("page-dash-geral").classList.toggle("hidden", page !== "dash-geral");
  $("page-dash-hospital").classList.toggle("hidden", page !== "dash-hospital");
  if(page !== "cadastro") renderDashboards();
}
document.querySelectorAll(".tab").forEach(btn => btn.addEventListener("click", () => goPage(btn.dataset.page)));

function renderAll(){
  renderTable();
  refreshResponsavelSelect();
  renderDashboards();
}

/** EVENTS */
$("btnTheme").addEventListener("click", toggleTheme);
$("btnSalvar").addEventListener("click", onSave);
$("btnLimpar").addEventListener("click", onClear);
$("btnRecarregar").addEventListener("click", loadFromSupabase);
$("btnCancelarEdicao").addEventListener("click", onCancelEdit);
$("q").addEventListener("input", renderTable);
$("btnExport").addEventListener("click", exportCSV);
$("selHospital").addEventListener("change", renderDashHospital);
$("btnImportExcel").addEventListener("click", importExcel);
$("btnWhatsAppPreview").addEventListener("click", previewWhatsApp);

$("btnCloseWaModal").addEventListener("click", closeWaModal);
$("waModal").addEventListener("click", (e)=>{ if(e.target === $("waModal")) closeWaModal(); });
$("waPreviewText").addEventListener("input", ()=>$("waCharCount").textContent = `Caracteres: ${($("waPreviewText").value||"").length}`);
$("btnCopyWa").addEventListener("click", copyWaText);
$("btnOpenWa").addEventListener("click", openWhatsAppFromModal);

/** START */
(async function init(){
  initTheme();
  initFixedFields();
  clearForm();
  await testConnection();
  await loadFromSupabase();
})();
</script>
</body>
</html>
